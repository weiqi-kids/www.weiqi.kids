"use strict";(globalThis.webpackChunktemp_docusaurus=globalThis.webpackChunktemp_docusaurus||[]).push([[8658],{75505(e,n,i){i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"tech/deep-dive/source-code","title":"KataGo Source Code Guide","description":"KataGo code structure, core modules, and architecture design","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/tech/deep-dive/source-code.md","sourceDirName":"tech/deep-dive","slug":"/tech/deep-dive/source-code","permalink":"/en/docs/tech/deep-dive/source-code","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tech/deep-dive/source-code.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"KataGo Source Code Guide","description":"KataGo code structure, core modules, and architecture design"},"sidebar":"tutorialSidebar","previous":{"title":"For Deep Learners","permalink":"/en/docs/tech/deep-dive/"},"next":{"title":"KataGo Training Mechanism","permalink":"/en/docs/tech/deep-dive/training"}}');var s=i(62615),o=i(30416);const l={sidebar_position:2,title:"KataGo Source Code Guide",description:"KataGo code structure, core modules, and architecture design"},a="KataGo Source Code Guide",t={},c=[{value:"Getting the Source Code",id:"getting-the-source-code",level:2},{value:"Directory Structure",id:"directory-structure",level:2},{value:"Core Module Analysis",id:"core-module-analysis",level:2},{value:"1. game/ \u2014 Go Rules",id:"1-game--go-rules",level:3},{value:"board.h / board.cpp",id:"boardh--boardcpp",level:4},{value:"rules.h / rules.cpp",id:"rulesh--rulescpp",level:4},{value:"2. search/ \u2014 MCTS Search",id:"2-search--mcts-search",level:3},{value:"search.h / search.cpp",id:"searchh--searchcpp",level:4},{value:"searchparams.h",id:"searchparamsh",level:4},{value:"3. neuralnet/ \u2014 Neural Network Inference",id:"3-neuralnet--neural-network-inference",level:3},{value:"nninputs.h / nninputs.cpp",id:"nninputsh--nninputscpp",level:4},{value:"nneval.h / nneval.cpp",id:"nnevalh--nnevalcpp",level:4},{value:"4. command/ \u2014 Command Handlers",id:"4-command--command-handlers",level:3},{value:"gtp.cpp",id:"gtpcpp",level:4},{value:"analysis.cpp",id:"analysiscpp",level:4},{value:"Python Training Code",id:"python-training-code",level:2},{value:"model.py \u2014 Network Architecture",id:"modelpy--network-architecture",level:3},{value:"train.py \u2014 Training Loop",id:"trainpy--training-loop",level:3},{value:"Key Algorithm Implementation",id:"key-algorithm-implementation",level:2},{value:"PUCT Selection Formula",id:"puct-selection-formula",level:3},{value:"Virtual Loss",id:"virtual-loss",level:3},{value:"Compilation &amp; Debugging",id:"compilation--debugging",level:2},{value:"Compilation (Debug Mode)",id:"compilation-debug-mode",level:3},{value:"Unit Tests",id:"unit-tests",level:3},{value:"Debugging Tips",id:"debugging-tips",level:3},{value:"Further Reading",id:"further-reading",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"katago-source-code-guide",children:"KataGo Source Code Guide"})}),"\n",(0,s.jsx)(n.p,{children:"This article helps you understand KataGo's code structure, suitable for engineers who want to dive deeper or contribute code."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"getting-the-source-code",children:"Getting the Source Code"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/lightvector/KataGo.git\ncd KataGo\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"directory-structure",children:"Directory Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"KataGo/\n\u251c\u2500\u2500 cpp/                    # C++ core engine\n\u2502   \u251c\u2500\u2500 main.cpp            # Main entry point\n\u2502   \u251c\u2500\u2500 command/            # Command handlers\n\u2502   \u251c\u2500\u2500 core/               # Core utilities\n\u2502   \u251c\u2500\u2500 game/               # Go rules\n\u2502   \u251c\u2500\u2500 search/             # MCTS search\n\u2502   \u251c\u2500\u2500 neuralnet/          # Neural network inference\n\u2502   \u251c\u2500\u2500 dataio/             # Data I/O\n\u2502   \u2514\u2500\u2500 tests/              # Unit tests\n\u2502\n\u251c\u2500\u2500 python/                 # Python training code\n\u2502   \u251c\u2500\u2500 train.py            # Training main program\n\u2502   \u251c\u2500\u2500 model.py            # Network architecture definition\n\u2502   \u251c\u2500\u2500 data/               # Data processing\n\u2502   \u2514\u2500\u2500 configs/            # Training configs\n\u2502\n\u2514\u2500\u2500 docs/                   # Documentation\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"core-module-analysis",children:"Core Module Analysis"}),"\n",(0,s.jsx)(n.h3,{id:"1-game--go-rules",children:"1. game/ \u2014 Go Rules"}),"\n",(0,s.jsx)(n.p,{children:"Complete implementation of Go rules."}),"\n",(0,s.jsx)(n.h4,{id:"boardh--boardcpp",children:"board.h / board.cpp"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Board state representation\nclass Board {\npublic:\n    static constexpr int MAX_BOARD_SIZE = 19;\n\n    // Board state\n    Color colors[MAX_ARR_SIZE];  // Color at each position\n    Chain chains[MAX_ARR_SIZE];  // Chain information\n\n    // Core operations\n    bool playMove(Loc loc, Player pla);  // Play a move\n    bool isLegal(Loc loc, Player pla);   // Check legality\n    void calculateArea(Color* area);      // Calculate territory\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A2 Lattice model: Board data structure"}),"\n",(0,s.jsx)(n.li,{children:"A6 Connected region: Chain representation"}),"\n",(0,s.jsx)(n.li,{children:"A7 Liberty calculation: Liberty tracking"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"rulesh--rulescpp",children:"rules.h / rules.cpp"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Multi-rule support\nstruct Rules {\n    enum KoRule { SIMPLE_KO, POSITIONAL_KO, SITUATIONAL_KO };\n    enum ScoringRule { TERRITORY_SCORING, AREA_SCORING };\n    enum TaxRule { NO_TAX, TAX_SEKI, TAX_ALL };\n\n    KoRule koRule;\n    ScoringRule scoringRule;\n    TaxRule taxRule;\n    float komi;\n\n    // Rule name mapping\n    static Rules parseRules(const std::string& name);\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Supported rules:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chinese"}),": Chinese rules (area scoring)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"japanese"}),": Japanese rules (territory scoring)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"korean"}),": Korean rules"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"aga"}),": American rules"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"tromp-taylor"}),": Tromp-Taylor rules"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"2-search--mcts-search",children:"2. search/ \u2014 MCTS Search"}),"\n",(0,s.jsx)(n.p,{children:"Monte Carlo Tree Search implementation."}),"\n",(0,s.jsx)(n.h4,{id:"searchh--searchcpp",children:"search.h / search.cpp"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"class Search {\npublic:\n    // Core search\n    void runWholeSearch(Player pla);\n\n    // MCTS steps\n    void selectNode();           // Select node\n    void expandNode();           // Expand node\n    void evaluateNode();         // Neural network evaluation\n    void backpropValue();        // Backpropagation\n\n    // Get results\n    Loc getChosenMove();\n    std::vector<MoveInfo> getSortedMoveInfos();\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"C5 MCTS four steps: Corresponds to select \u2192 expand \u2192 evaluate \u2192 backprop"}),"\n",(0,s.jsxs)(n.li,{children:["E4 PUCT formula: Implemented in ",(0,s.jsx)(n.code,{children:"selectNode()"})]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"searchparamsh",children:"searchparams.h"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"struct SearchParams {\n    // Search control\n    int64_t maxVisits;          // Maximum visits\n    double maxTime;             // Maximum time\n\n    // PUCT parameters\n    double cpuctExploration;    // Exploration constant\n    double cpuctBase;\n\n    // Virtual loss\n    int virtualLoss;\n\n    // Root noise\n    double rootNoiseEnabled;\n    double rootDirichletAlpha;\n};\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"3-neuralnet--neural-network-inference",children:"3. neuralnet/ \u2014 Neural Network Inference"}),"\n",(0,s.jsx)(n.p,{children:"Neural network inference engine."}),"\n",(0,s.jsx)(n.h4,{id:"nninputsh--nninputscpp",children:"nninputs.h / nninputs.cpp"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Neural network input features\nclass NNInputs {\npublic:\n    // Feature planes\n    static constexpr int NUM_FEATURES = 22;\n\n    // Fill features\n    static void fillFeatures(\n        const Board& board,\n        const BoardHistory& hist,\n        float* features\n    );\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Input features include:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Black stone positions, White stone positions"}),"\n",(0,s.jsx)(n.li,{children:"Liberty counts (1, 2, 3+)"}),"\n",(0,s.jsx)(n.li,{children:"History moves"}),"\n",(0,s.jsx)(n.li,{children:"Rule encoding"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A10 History stacking: Multi-frame input"}),"\n",(0,s.jsx)(n.li,{children:"A11 Legal move mask: Forbidden move filtering"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"nnevalh--nnevalcpp",children:"nneval.h / nneval.cpp"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Neural network evaluation result\nstruct NNOutput {\n    // Policy output (362 positions, including pass)\n    float policyProbs[NNPos::MAX_NN_POLICY_SIZE];\n\n    // Value output\n    float winProb;       // Win probability\n    float lossProb;      // Loss probability\n    float noResultProb;  // Draw probability\n\n    // Auxiliary outputs\n    float scoreMean;     // Score prediction\n    float scoreStdev;    // Score standard deviation\n    float lead;          // Lead in points\n\n    // Territory prediction\n    float ownership[NNPos::MAX_BOARD_AREA];\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"E1 Policy network: policyProbs"}),"\n",(0,s.jsx)(n.li,{children:"E2 Value network: winProb, scoreMean"}),"\n",(0,s.jsx)(n.li,{children:"E3 Dual-head network: Multi-head output design"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"4-command--command-handlers",children:"4. command/ \u2014 Command Handlers"}),"\n",(0,s.jsx)(n.p,{children:"Implementation of different running modes."}),"\n",(0,s.jsx)(n.h4,{id:"gtpcpp",children:"gtp.cpp"}),"\n",(0,s.jsx)(n.p,{children:"GTP (Go Text Protocol) mode implementation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'void MainCmds::gtp(const std::vector<std::string>& args) {\n    // Command parsing and execution\n    while(true) {\n        std::string line;\n        std::getline(std::cin, line);\n\n        if(line == "name") {\n            respond("KataGo");\n        }\n        else if(line.find("play") == 0) {\n            // Handle play command\n        }\n        else if(line.find("genmove") == 0) {\n            // Execute search and return best move\n        }\n        // ... other commands\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"analysiscpp",children:"analysis.cpp"}),"\n",(0,s.jsx)(n.p,{children:"Analysis Engine implementation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"void MainCmds::analysis(const std::vector<std::string>& args) {\n    while(true) {\n        // Read JSON request\n        std::string line;\n        std::getline(std::cin, line);\n        json query = json::parse(line);\n\n        // Setup board state\n        Board board = setupBoard(query);\n\n        // Execute analysis\n        Search search(...);\n        search.runWholeSearch();\n\n        // Output JSON response\n        json response = formatResponse(search);\n        std::cout << response.dump() << std::endl;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"python-training-code",children:"Python Training Code"}),"\n",(0,s.jsx)(n.h3,{id:"modelpy--network-architecture",children:"model.py \u2014 Network Architecture"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"class Model(nn.Module):\n    def __init__(self, config):\n        super().__init__()\n\n        # Initial convolution\n        self.initial_conv = nn.Conv2d(\n            in_channels=config.input_features,\n            out_channels=config.trunk_channels,\n            kernel_size=3, padding=1\n        )\n\n        # Residual tower\n        self.trunk = nn.ModuleList([\n            ResidualBlock(config.trunk_channels)\n            for _ in range(config.num_blocks)\n        ])\n\n        # Output heads\n        self.policy_head = PolicyHead(config)\n        self.value_head = ValueHead(config)\n        self.ownership_head = OwnershipHead(config)\n\n    def forward(self, x):\n        # Initial convolution\n        x = self.initial_conv(x)\n\n        # Residual tower\n        for block in self.trunk:\n            x = block(x)\n\n        # Multi-head output\n        policy = self.policy_head(x)\n        value = self.value_head(x)\n        ownership = self.ownership_head(x)\n\n        return policy, value, ownership\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"D9 Convolution operation: Conv2d"}),"\n",(0,s.jsx)(n.li,{children:"D12 Residual connection: ResidualBlock"}),"\n",(0,s.jsx)(n.li,{children:"E11 Residual tower: trunk structure"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"trainpy--training-loop",children:"train.py \u2014 Training Loop"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"def train_step(model, optimizer, batch):\n    # Forward pass\n    policy_pred, value_pred, ownership_pred = model(batch.inputs)\n\n    # Compute loss\n    policy_loss = cross_entropy(policy_pred, batch.policy_target)\n    value_loss = mse_loss(value_pred, batch.value_target)\n    ownership_loss = mse_loss(ownership_pred, batch.ownership_target)\n\n    total_loss = policy_loss + value_loss + ownership_loss\n\n    # Backward pass\n    optimizer.zero_grad()\n    total_loss.backward()\n    optimizer.step()\n\n    return total_loss.item()\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"D3 Forward propagation: model(batch.inputs)"}),"\n",(0,s.jsx)(n.li,{children:"D13 Backward propagation: total_loss.backward()"}),"\n",(0,s.jsx)(n.li,{children:"K3 Adam: optimizer.step()"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"key-algorithm-implementation",children:"Key Algorithm Implementation"}),"\n",(0,s.jsx)(n.h3,{id:"puct-selection-formula",children:"PUCT Selection Formula"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// search.cpp\ndouble Search::getPUCTScore(const SearchNode* node, int moveIdx) {\n    double Q = node->getChildValue(moveIdx);\n    double P = node->getChildPolicy(moveIdx);\n    double N_parent = node->visits;\n    double N_child = node->getChildVisits(moveIdx);\n\n    double exploration = params.cpuctExploration;\n    double cpuct = exploration * sqrt(N_parent) / (1.0 + N_child);\n\n    return Q + cpuct * P;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"virtual-loss",children:"Virtual Loss"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Prevent multiple threads selecting same node\nvoid Search::applyVirtualLoss(SearchNode* node) {\n    node->virtualLoss += params.virtualLoss;\n}\n\nvoid Search::removeVirtualLoss(SearchNode* node) {\n    node->virtualLoss -= params.virtualLoss;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Animation correspondence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"C9 Virtual loss: Parallel search technique"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"compilation--debugging",children:"Compilation & Debugging"}),"\n",(0,s.jsx)(n.h3,{id:"compilation-debug-mode",children:"Compilation (Debug Mode)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd cpp\nmkdir build && cd build\ncmake .. -DUSE_BACKEND=OPENCL -DCMAKE_BUILD_TYPE=Debug\nmake -j$(nproc)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"./katago runtests\n"})}),"\n",(0,s.jsx)(n.h3,{id:"debugging-tips",children:"Debugging Tips"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"// Enable detailed logging\n#define SEARCH_DEBUG 1\n\n// Add breakpoint in search\nif(node->visits > 1000) {\n    // Set breakpoint to check search state\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"further-reading",children:"Further Reading"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"../training",children:"KataGo Training Mechanism"})," \u2014 Complete training process"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"../contributing",children:"Contributing to Open Source"})," \u2014 Contribution guide"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"../../how-it-works/concepts/",children:"Concept Quick Reference"})," \u2014 109 concept mappings"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},30416(e,n,i){i.d(n,{R:()=>l,x:()=>a});var r=i(59471);const s={},o=r.createContext(s);function l(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);