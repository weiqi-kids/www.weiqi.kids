"use strict";(self.webpackChunktemp_docusaurus=self.webpackChunktemp_docusaurus||[]).push([[2801],{5521:(n,e,s)=>{s.d(e,{R:()=>c,x:()=>a});var l=s(6672);const i={},r=l.createContext(i);function c(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),l.createElement(r.Provider,{value:e},n.children)}},8826:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>l,toc:()=>o});const l=JSON.parse('{"id":"for-engineers/deep-dive/source-code","title":"KataGo \u539f\u59cb\u78bc\u5c0e\u8b80","description":"KataGo \u7a0b\u5f0f\u78bc\u7d50\u69cb\u3001\u6838\u5fc3\u6a21\u7d44\u8207\u67b6\u69cb\u8a2d\u8a08","source":"@site/docs/for-engineers/deep-dive/source-code.md","sourceDirName":"for-engineers/deep-dive","slug":"/for-engineers/deep-dive/source-code","permalink":"/en/docs/for-engineers/deep-dive/source-code","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/for-engineers/deep-dive/source-code.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"KataGo \u539f\u59cb\u78bc\u5c0e\u8b80","description":"KataGo \u7a0b\u5f0f\u78bc\u7d50\u69cb\u3001\u6838\u5fc3\u6a21\u7d44\u8207\u67b6\u69cb\u8a2d\u8a08"},"sidebar":"tutorialSidebar","previous":{"title":"\u7d66\u60f3\u6df1\u5165\u7814\u7a76\u7684\u4eba","permalink":"/en/docs/for-engineers/deep-dive/"},"next":{"title":"\u8a13\u7df4\u81ea\u5df1\u7684\u6a21\u578b","permalink":"/en/docs/for-engineers/deep-dive/training"}}');var i=s(3420),r=s(5521);const c={sidebar_position:2,title:"KataGo \u539f\u59cb\u78bc\u5c0e\u8b80",description:"KataGo \u7a0b\u5f0f\u78bc\u7d50\u69cb\u3001\u6838\u5fc3\u6a21\u7d44\u8207\u67b6\u69cb\u8a2d\u8a08"},a="KataGo \u539f\u59cb\u78bc\u5c0e\u8b80",d={},o=[{value:"\u53d6\u5f97\u539f\u59cb\u78bc",id:"\u53d6\u5f97\u539f\u59cb\u78bc",level:2},{value:"\u76ee\u9304\u7d50\u69cb",id:"\u76ee\u9304\u7d50\u69cb",level:2},{value:"\u6838\u5fc3\u6a21\u7d44\u89e3\u6790",id:"\u6838\u5fc3\u6a21\u7d44\u89e3\u6790",level:2},{value:"1. game/ \u2014 \u570d\u68cb\u898f\u5247",id:"1-game--\u570d\u68cb\u898f\u5247",level:3},{value:"board.h / board.cpp",id:"boardh--boardcpp",level:4},{value:"rules.h / rules.cpp",id:"rulesh--rulescpp",level:4},{value:"2. search/ \u2014 MCTS \u641c\u7d22",id:"2-search--mcts-\u641c\u7d22",level:3},{value:"search.h / search.cpp",id:"searchh--searchcpp",level:4},{value:"searchparams.h",id:"searchparamsh",level:4},{value:"3. neuralnet/ \u2014 \u795e\u7d93\u7db2\u8def\u63a8\u7406",id:"3-neuralnet--\u795e\u7d93\u7db2\u8def\u63a8\u7406",level:3},{value:"nninputs.h / nninputs.cpp",id:"nninputsh--nninputscpp",level:4},{value:"nneval.h / nneval.cpp",id:"nnevalh--nnevalcpp",level:4},{value:"4. command/ \u2014 \u6307\u4ee4\u8655\u7406",id:"4-command--\u6307\u4ee4\u8655\u7406",level:3},{value:"gtp.cpp",id:"gtpcpp",level:4},{value:"analysis.cpp",id:"analysiscpp",level:4},{value:"Python \u8a13\u7df4\u7a0b\u5f0f\u78bc",id:"python-\u8a13\u7df4\u7a0b\u5f0f\u78bc",level:2},{value:"model.py \u2014 \u7db2\u8def\u67b6\u69cb",id:"modelpy--\u7db2\u8def\u67b6\u69cb",level:3},{value:"train.py \u2014 \u8a13\u7df4\u5faa\u74b0",id:"trainpy--\u8a13\u7df4\u5faa\u74b0",level:3},{value:"\u95dc\u9375\u6f14\u7b97\u6cd5\u5be6\u4f5c",id:"\u95dc\u9375\u6f14\u7b97\u6cd5\u5be6\u4f5c",level:2},{value:"PUCT \u9078\u64c7\u516c\u5f0f",id:"puct-\u9078\u64c7\u516c\u5f0f",level:3},{value:"\u865b\u64ec\u640d\u5931",id:"\u865b\u64ec\u640d\u5931",level:3},{value:"\u7de8\u8b6f\u8207\u9664\u932f",id:"\u7de8\u8b6f\u8207\u9664\u932f",level:2},{value:"\u7de8\u8b6f\uff08Debug \u6a21\u5f0f\uff09",id:"\u7de8\u8b6fdebug-\u6a21\u5f0f",level:3},{value:"\u55ae\u5143\u6e2c\u8a66",id:"\u55ae\u5143\u6e2c\u8a66",level:3},{value:"\u9664\u932f\u6280\u5de7",id:"\u9664\u932f\u6280\u5de7",level:3},{value:"\u5ef6\u4f38\u95b1\u8b80",id:"\u5ef6\u4f38\u95b1\u8b80",level:2}];function t(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"katago-\u539f\u59cb\u78bc\u5c0e\u8b80",children:"KataGo \u539f\u59cb\u78bc\u5c0e\u8b80"})}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u6587\u5e36\u4f60\u4e86\u89e3 KataGo \u7684\u7a0b\u5f0f\u78bc\u7d50\u69cb\uff0c\u9069\u5408\u60f3\u6df1\u5165\u7814\u7a76\u6216\u8ca2\u737b\u7a0b\u5f0f\u78bc\u7684\u5de5\u7a0b\u5e2b\u3002"}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u53d6\u5f97\u539f\u59cb\u78bc",children:"\u53d6\u5f97\u539f\u59cb\u78bc"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"git clone https://github.com/lightvector/KataGo.git\ncd KataGo\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u76ee\u9304\u7d50\u69cb",children:"\u76ee\u9304\u7d50\u69cb"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"KataGo/\n\u251c\u2500\u2500 cpp/                    # C++ \u6838\u5fc3\u5f15\u64ce\n\u2502   \u251c\u2500\u2500 main.cpp            # \u4e3b\u7a0b\u5f0f\u5165\u53e3\n\u2502   \u251c\u2500\u2500 command/            # \u6307\u4ee4\u8655\u7406\n\u2502   \u251c\u2500\u2500 core/               # \u6838\u5fc3\u5de5\u5177\n\u2502   \u251c\u2500\u2500 game/               # \u570d\u68cb\u898f\u5247\n\u2502   \u251c\u2500\u2500 search/             # MCTS \u641c\u7d22\n\u2502   \u251c\u2500\u2500 neuralnet/          # \u795e\u7d93\u7db2\u8def\u63a8\u7406\n\u2502   \u251c\u2500\u2500 dataio/             # \u8cc7\u6599 I/O\n\u2502   \u2514\u2500\u2500 tests/              # \u55ae\u5143\u6e2c\u8a66\n\u2502\n\u251c\u2500\u2500 python/                 # Python \u8a13\u7df4\u7a0b\u5f0f\u78bc\n\u2502   \u251c\u2500\u2500 train.py            # \u8a13\u7df4\u4e3b\u7a0b\u5f0f\n\u2502   \u251c\u2500\u2500 model.py            # \u7db2\u8def\u67b6\u69cb\u5b9a\u7fa9\n\u2502   \u251c\u2500\u2500 data/               # \u8cc7\u6599\u8655\u7406\n\u2502   \u2514\u2500\u2500 configs/            # \u8a13\u7df4\u8a2d\u5b9a\n\u2502\n\u2514\u2500\u2500 docs/                   # \u6587\u4ef6\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u6838\u5fc3\u6a21\u7d44\u89e3\u6790",children:"\u6838\u5fc3\u6a21\u7d44\u89e3\u6790"}),"\n",(0,i.jsx)(e.h3,{id:"1-game--\u570d\u68cb\u898f\u5247",children:"1. game/ \u2014 \u570d\u68cb\u898f\u5247"}),"\n",(0,i.jsx)(e.p,{children:"\u570d\u68cb\u898f\u5247\u7684\u5b8c\u6574\u5be6\u4f5c\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"boardh--boardcpp",children:"board.h / board.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u68cb\u76e4\u72c0\u614b\u8868\u793a\nclass Board {\npublic:\n    static constexpr int MAX_BOARD_SIZE = 19;\n\n    // \u68cb\u76e4\u72c0\u614b\n    Color colors[MAX_ARR_SIZE];  // \u6bcf\u500b\u4f4d\u7f6e\u7684\u984f\u8272\n    Chain chains[MAX_ARR_SIZE];  // \u68cb\u4e32\u8cc7\u8a0a\n\n    // \u6838\u5fc3\u64cd\u4f5c\n    bool playMove(Loc loc, Player pla);  // \u4e0b\u4e00\u6b65\u68cb\n    bool isLegal(Loc loc, Player pla);   // \u5224\u65b7\u5408\u6cd5\u6027\n    void calculateArea(Color* area);      // \u8a08\u7b97\u9818\u5730\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac A2 \u6676\u683c\u6a21\u578b\uff1a\u68cb\u76e4\u7684\u8cc7\u6599\u7d50\u69cb"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac A6 \u9023\u901a\u5340\u57df\uff1a\u68cb\u4e32\uff08Chain\uff09\u7684\u8868\u793a"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac A7 \u6c23\u7684\u8a08\u7b97\uff1aliberty \u7684\u8ffd\u8e64"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"rulesh--rulescpp",children:"rules.h / rules.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u591a\u898f\u5247\u652f\u63f4\nstruct Rules {\n    enum KoRule { SIMPLE_KO, POSITIONAL_KO, SITUATIONAL_KO };\n    enum ScoringRule { TERRITORY_SCORING, AREA_SCORING };\n    enum TaxRule { NO_TAX, TAX_SEKI, TAX_ALL };\n\n    KoRule koRule;\n    ScoringRule scoringRule;\n    TaxRule taxRule;\n    float komi;\n\n    // \u898f\u5247\u540d\u7a31\u5c0d\u61c9\n    static Rules parseRules(const std::string& name);\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u652f\u63f4\u7684\u898f\u5247\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"chinese"}),"\uff1a\u4e2d\u570b\u898f\u5247\uff08\u6578\u5b50\uff09"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"japanese"}),"\uff1a\u65e5\u672c\u898f\u5247\uff08\u6578\u76ee\uff09"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"korean"}),"\uff1a\u97d3\u570b\u898f\u5247"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"aga"}),"\uff1a\u7f8e\u570b\u898f\u5247"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"tromp-taylor"}),"\uff1aTromp-Taylor \u898f\u5247"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"2-search--mcts-\u641c\u7d22",children:"2. search/ \u2014 MCTS \u641c\u7d22"}),"\n",(0,i.jsx)(e.p,{children:"\u8499\u5730\u5361\u7f85\u6a39\u641c\u7d22\u7684\u5be6\u4f5c\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"searchh--searchcpp",children:"search.h / search.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"class Search {\npublic:\n    // \u6838\u5fc3\u641c\u7d22\n    void runWholeSearch(Player pla);\n\n    // MCTS \u6b65\u9a5f\n    void selectNode();           // \u9078\u64c7\u7bc0\u9ede\n    void expandNode();           // \u64f4\u5c55\u7bc0\u9ede\n    void evaluateNode();         // \u795e\u7d93\u7db2\u8def\u8a55\u4f30\n    void backpropValue();        // \u56de\u50b3\u66f4\u65b0\n\n    // \u7d50\u679c\u53d6\u5f97\n    Loc getChosenMove();\n    std::vector<MoveInfo> getSortedMoveInfos();\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac C5 MCTS \u56db\u6b65\u9a5f\uff1a\u5c0d\u61c9 select \u2192 expand \u2192 evaluate \u2192 backprop"}),"\n",(0,i.jsxs)(e.li,{children:["\ud83c\udfac E4 PUCT \u516c\u5f0f\uff1a\u5728 ",(0,i.jsx)(e.code,{children:"selectNode()"})," \u4e2d\u5be6\u4f5c"]}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"searchparamsh",children:"searchparams.h"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"struct SearchParams {\n    // \u641c\u7d22\u63a7\u5236\n    int64_t maxVisits;          // \u6700\u5927\u8a2a\u554f\u6b21\u6578\n    double maxTime;             // \u6700\u5927\u6642\u9593\n\n    // PUCT \u53c3\u6578\n    double cpuctExploration;    // \u63a2\u7d22\u5e38\u6578\n    double cpuctBase;\n\n    // \u865b\u64ec\u640d\u5931\n    int virtualLoss;\n\n    // \u6839\u7bc0\u9ede\u96dc\u8a0a\n    double rootNoiseEnabled;\n    double rootDirichletAlpha;\n};\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"3-neuralnet--\u795e\u7d93\u7db2\u8def\u63a8\u7406",children:"3. neuralnet/ \u2014 \u795e\u7d93\u7db2\u8def\u63a8\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u795e\u7d93\u7db2\u8def\u7684\u63a8\u7406\u5f15\u64ce\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"nninputsh--nninputscpp",children:"nninputs.h / nninputs.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u795e\u7d93\u7db2\u8def\u8f38\u5165\u7279\u5fb5\nclass NNInputs {\npublic:\n    // \u7279\u5fb5\u5e73\u9762\n    static constexpr int NUM_FEATURES = 22;\n\n    // \u586b\u5145\u7279\u5fb5\n    static void fillFeatures(\n        const Board& board,\n        const BoardHistory& hist,\n        float* features\n    );\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u8f38\u5165\u7279\u5fb5\u5305\u62ec\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u9ed1\u5b50\u4f4d\u7f6e\u3001\u767d\u5b50\u4f4d\u7f6e"}),"\n",(0,i.jsx)(e.li,{children:"\u6c23\u6578\uff081, 2, 3+\uff09"}),"\n",(0,i.jsx)(e.li,{children:"\u6b77\u53f2\u68cb\u6b65"}),"\n",(0,i.jsx)(e.li,{children:"\u898f\u5247\u7de8\u78bc"}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac A10 \u6b77\u53f2\u5806\u758a\uff1a\u591a\u5e40\u8f38\u5165"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac A11 \u5408\u6cd5\u624b\u906e\u7f69\uff1a\u7981\u624b\u904e\u6ffe"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"nnevalh--nnevalcpp",children:"nneval.h / nneval.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u795e\u7d93\u7db2\u8def\u8a55\u4f30\u7d50\u679c\nstruct NNOutput {\n    // Policy \u8f38\u51fa\uff08362 \u500b\u4f4d\u7f6e\uff0c\u542b pass\uff09\n    float policyProbs[NNPos::MAX_NN_POLICY_SIZE];\n\n    // Value \u8f38\u51fa\n    float winProb;       // \u52dd\u7387\n    float lossProb;      // \u6557\u7387\n    float noResultProb;  // \u548c\u68cb\u7387\n\n    // \u8f14\u52a9\u8f38\u51fa\n    float scoreMean;     // \u76ee\u6578\u9810\u6e2c\n    float scoreStdev;    // \u76ee\u6578\u6a19\u6e96\u5dee\n    float lead;          // \u9818\u5148\u76ee\u6578\n\n    // \u9818\u5730\u9810\u6e2c\n    float ownership[NNPos::MAX_BOARD_AREA];\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac E1 \u7b56\u7565\u7db2\u8def\uff1apolicyProbs"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac E2 \u50f9\u503c\u7db2\u8def\uff1awinProb, scoreMean"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac E3 \u96d9\u982d\u7db2\u8def\uff1a\u591a\u8f38\u51fa\u982d\u8a2d\u8a08"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"4-command--\u6307\u4ee4\u8655\u7406",children:"4. command/ \u2014 \u6307\u4ee4\u8655\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0d\u540c\u904b\u884c\u6a21\u5f0f\u7684\u5be6\u4f5c\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"gtpcpp",children:"gtp.cpp"}),"\n",(0,i.jsx)(e.p,{children:"GTP\uff08Go Text Protocol\uff09\u6a21\u5f0f\u7684\u5be6\u4f5c\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'void MainCmds::gtp(const std::vector<std::string>& args) {\n    // \u6307\u4ee4\u89e3\u6790\u8207\u57f7\u884c\n    while(true) {\n        std::string line;\n        std::getline(std::cin, line);\n\n        if(line == "name") {\n            respond("KataGo");\n        }\n        else if(line.find("play") == 0) {\n            // \u8655\u7406\u4e0b\u68cb\u6307\u4ee4\n        }\n        else if(line.find("genmove") == 0) {\n            // \u57f7\u884c\u641c\u7d22\u4e26\u56de\u50b3\u6700\u4f73\u4e0b\u6cd5\n        }\n        // ... \u5176\u4ed6\u6307\u4ee4\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h4,{id:"analysiscpp",children:"analysis.cpp"}),"\n",(0,i.jsx)(e.p,{children:"Analysis Engine \u7684\u5be6\u4f5c\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"void MainCmds::analysis(const std::vector<std::string>& args) {\n    while(true) {\n        // \u8b80\u53d6 JSON \u8acb\u6c42\n        std::string line;\n        std::getline(std::cin, line);\n        json query = json::parse(line);\n\n        // \u5efa\u7acb\u68cb\u76e4\u72c0\u614b\n        Board board = setupBoard(query);\n\n        // \u57f7\u884c\u5206\u6790\n        Search search(...);\n        search.runWholeSearch();\n\n        // \u8f38\u51fa JSON \u56de\u61c9\n        json response = formatResponse(search);\n        std::cout << response.dump() << std::endl;\n    }\n}\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"python-\u8a13\u7df4\u7a0b\u5f0f\u78bc",children:"Python \u8a13\u7df4\u7a0b\u5f0f\u78bc"}),"\n",(0,i.jsx)(e.h3,{id:"modelpy--\u7db2\u8def\u67b6\u69cb",children:"model.py \u2014 \u7db2\u8def\u67b6\u69cb"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"class Model(nn.Module):\n    def __init__(self, config):\n        super().__init__()\n\n        # \u521d\u59cb\u5377\u7a4d\n        self.initial_conv = nn.Conv2d(\n            in_channels=config.input_features,\n            out_channels=config.trunk_channels,\n            kernel_size=3, padding=1\n        )\n\n        # \u6b98\u5dee\u5854\n        self.trunk = nn.ModuleList([\n            ResidualBlock(config.trunk_channels)\n            for _ in range(config.num_blocks)\n        ])\n\n        # \u8f38\u51fa\u982d\n        self.policy_head = PolicyHead(config)\n        self.value_head = ValueHead(config)\n        self.ownership_head = OwnershipHead(config)\n\n    def forward(self, x):\n        # \u521d\u59cb\u5377\u7a4d\n        x = self.initial_conv(x)\n\n        # \u6b98\u5dee\u5854\n        for block in self.trunk:\n            x = block(x)\n\n        # \u591a\u982d\u8f38\u51fa\n        policy = self.policy_head(x)\n        value = self.value_head(x)\n        ownership = self.ownership_head(x)\n\n        return policy, value, ownership\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac D9 \u5377\u7a4d\u904b\u7b97\uff1aConv2d"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac D12 \u6b98\u5dee\u9023\u63a5\uff1aResidualBlock"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac E11 \u6b98\u5dee\u5854\uff1atrunk \u7d50\u69cb"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"trainpy--\u8a13\u7df4\u5faa\u74b0",children:"train.py \u2014 \u8a13\u7df4\u5faa\u74b0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"def train_step(model, optimizer, batch):\n    # \u524d\u5411\u50b3\u64ad\n    policy_pred, value_pred, ownership_pred = model(batch.inputs)\n\n    # \u8a08\u7b97\u640d\u5931\n    policy_loss = cross_entropy(policy_pred, batch.policy_target)\n    value_loss = mse_loss(value_pred, batch.value_target)\n    ownership_loss = mse_loss(ownership_pred, batch.ownership_target)\n\n    total_loss = policy_loss + value_loss + ownership_loss\n\n    # \u53cd\u5411\u50b3\u64ad\n    optimizer.zero_grad()\n    total_loss.backward()\n    optimizer.step()\n\n    return total_loss.item()\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac D3 \u524d\u5411\u50b3\u64ad\uff1amodel(batch.inputs)"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac D13 \u53cd\u5411\u50b3\u64ad\uff1atotal_loss.backward()"}),"\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac K3 Adam\uff1aoptimizer.step()"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u95dc\u9375\u6f14\u7b97\u6cd5\u5be6\u4f5c",children:"\u95dc\u9375\u6f14\u7b97\u6cd5\u5be6\u4f5c"}),"\n",(0,i.jsx)(e.h3,{id:"puct-\u9078\u64c7\u516c\u5f0f",children:"PUCT \u9078\u64c7\u516c\u5f0f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// search.cpp\ndouble Search::getPUCTScore(const SearchNode* node, int moveIdx) {\n    double Q = node->getChildValue(moveIdx);\n    double P = node->getChildPolicy(moveIdx);\n    double N_parent = node->visits;\n    double N_child = node->getChildVisits(moveIdx);\n\n    double exploration = params.cpuctExploration;\n    double cpuct = exploration * sqrt(N_parent) / (1.0 + N_child);\n\n    return Q + cpuct * P;\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u865b\u64ec\u640d\u5931",children:"\u865b\u64ec\u640d\u5931"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u907f\u514d\u591a\u57f7\u884c\u7dd2\u9078\u64c7\u76f8\u540c\u7bc0\u9ede\nvoid Search::applyVirtualLoss(SearchNode* node) {\n    node->virtualLoss += params.virtualLoss;\n}\n\nvoid Search::removeVirtualLoss(SearchNode* node) {\n    node->virtualLoss -= params.virtualLoss;\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52d5\u756b\u5c0d\u61c9"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\ud83c\udfac C9 \u865b\u64ec\u640d\u5931\uff1a\u4e26\u884c\u641c\u7d22\u7684\u6280\u5de7"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u7de8\u8b6f\u8207\u9664\u932f",children:"\u7de8\u8b6f\u8207\u9664\u932f"}),"\n",(0,i.jsx)(e.h3,{id:"\u7de8\u8b6fdebug-\u6a21\u5f0f",children:"\u7de8\u8b6f\uff08Debug \u6a21\u5f0f\uff09"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"cd cpp\nmkdir build && cd build\ncmake .. -DUSE_BACKEND=OPENCL -DCMAKE_BUILD_TYPE=Debug\nmake -j$(nproc)\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u55ae\u5143\u6e2c\u8a66",children:"\u55ae\u5143\u6e2c\u8a66"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"./katago runtests\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u9664\u932f\u6280\u5de7",children:"\u9664\u932f\u6280\u5de7"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u555f\u7528\u8a73\u7d30\u65e5\u8a8c\n#define SEARCH_DEBUG 1\n\n// \u5728\u641c\u7d22\u4e2d\u52a0\u5165\u65b7\u9ede\nif(node->visits > 1000) {\n    // \u8a2d\u7f6e\u65b7\u9ede\u6aa2\u67e5\u641c\u7d22\u72c0\u614b\n}\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u5ef6\u4f38\u95b1\u8b80",children:"\u5ef6\u4f38\u95b1\u8b80"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../training",children:"\u8a13\u7df4\u81ea\u5df1\u7684\u6a21\u578b"})," \u2014 \u5b8c\u6574\u8a13\u7df4\u6d41\u7a0b"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../contributing",children:"\u53c3\u8207\u958b\u6e90\u793e\u7fa4"})," \u2014 \u8ca2\u737b\u6307\u5357"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../../how-it-works/concepts/",children:"\u6982\u5ff5\u901f\u67e5\u8868"})," \u2014 109 \u500b\u6982\u5ff5\u5c0d\u7167"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(t,{...n})}):t(n)}}}]);