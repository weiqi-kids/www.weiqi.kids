# GitHub Actions Workflow: Generate Traffic Report
# Generates weekly traffic analysis report from collected data

name: Generate Traffic Report

on:
  schedule:
    - cron: '0 1 * * 1'  # Every Monday at UTC 01:00
  workflow_dispatch:      # Manual trigger

permissions:
  contents: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Weekly Report
        run: |
          YEAR=$(date +%Y)
          WEEK=$(date +%W)
          REPORT_FILE="analytics/reports/weekly-${YEAR}-W${WEEK}.md"

          echo "# 流量週報 Weekly Traffic Report" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Week ${WEEK}, ${YEAR}**" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "Generated: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Popular Pages
          echo "## 熱門頁面 Popular Pages" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if [ -f "analytics/current/popular-paths.json" ]; then
            echo "| 排名 | 頁面 | 瀏覽數 | 獨立訪客 |" >> "$REPORT_FILE"
            echo "|------|------|--------|----------|" >> "$REPORT_FILE"
            jq -r 'to_entries | .[] | "| \(.key + 1) | \(.value.path) | \(.value.count) | \(.value.uniques) |"' \
              analytics/current/popular-paths.json >> "$REPORT_FILE"
          else
            echo "(無數據)" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Referrers
          echo "## 流量來源 Referrers" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if [ -f "analytics/current/referrers.json" ]; then
            echo "| 排名 | 來源 | 訪問數 | 獨立訪客 |" >> "$REPORT_FILE"
            echo "|------|------|--------|----------|" >> "$REPORT_FILE"
            jq -r 'to_entries | .[] | "| \(.key + 1) | \(.value.referrer) | \(.value.count) | \(.value.uniques) |"' \
              analytics/current/referrers.json >> "$REPORT_FILE"
          else
            echo "(無數據)" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Weekly Trend
          echo "## 本週瀏覽趨勢 Weekly Trend" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if [ -f "analytics/history/daily-views.json" ]; then
            echo "| 日期 | 瀏覽數 | 獨立訪客 |" >> "$REPORT_FILE"
            echo "|------|--------|----------|" >> "$REPORT_FILE"
            jq -r '.views | .[-7:] | .[] | "| \(.timestamp | split("T")[0]) | \(.count) | \(.uniques) |"' \
              analytics/history/daily-views.json >> "$REPORT_FILE"

            # Calculate weekly totals
            WEEKLY_VIEWS=$(jq '[.views[-7:][].count] | add // 0' analytics/history/daily-views.json)
            WEEKLY_UNIQUES=$(jq '[.views[-7:][].uniques] | add // 0' analytics/history/daily-views.json)
            echo "" >> "$REPORT_FILE"
            echo "**週總計**: ${WEEKLY_VIEWS} 瀏覽 / ${WEEKLY_UNIQUES} 獨立訪客" >> "$REPORT_FILE"
          else
            echo "(無歷史數據)" >> "$REPORT_FILE"
          fi

          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "*Report generated by GitHub Actions*" >> "$REPORT_FILE"

      - name: Commit Report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add analytics/reports/
          if git diff --staged --quiet; then
            echo "No new report to commit"
          else
            git commit -m "docs: weekly traffic report $(date +%Y)-W$(date +%W)"
            git push
          fi
