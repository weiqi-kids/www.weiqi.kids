"use strict";(globalThis.webpackChunktemp_docusaurus=globalThis.webpackChunktemp_docusaurus||[]).push([[1104],{96767(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>o});const l=JSON.parse('{"id":"for-engineers/deep-dive/mcts-implementation","title":"MCTS\u5b9f\u88c5\u8a73\u7d30","description":"\u30e2\u30f3\u30c6\u30ab\u30eb\u30ed\u6728\u63a2\u7d22\u306e\u5b9f\u88c5\u3001PUCT\u9078\u629e\u3001\u4e26\u5217\u5316\u6280\u8853\u306e\u8a73\u7d30\u89e3\u8aac","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/for-engineers/deep-dive/mcts-implementation.md","sourceDirName":"for-engineers/deep-dive","slug":"/for-engineers/deep-dive/mcts-implementation","permalink":"/ja/docs/for-engineers/deep-dive/mcts-implementation","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/for-engineers/deep-dive/mcts-implementation.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"MCTS\u5b9f\u88c5\u8a73\u7d30","description":"\u30e2\u30f3\u30c6\u30ab\u30eb\u30ed\u6728\u63a2\u7d22\u306e\u5b9f\u88c5\u3001PUCT\u9078\u629e\u3001\u4e26\u5217\u5316\u6280\u8853\u306e\u8a73\u7d30\u89e3\u8aac"},"sidebar":"tutorialSidebar","previous":{"title":"\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a73\u89e3","permalink":"/ja/docs/for-engineers/deep-dive/neural-network"},"next":{"title":"GPU\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u6700\u9069\u5316","permalink":"/ja/docs/for-engineers/deep-dive/gpu-optimization"}}');var i=s(62615),t=s(30416);const r={sidebar_position:5,title:"MCTS\u5b9f\u88c5\u8a73\u7d30",description:"\u30e2\u30f3\u30c6\u30ab\u30eb\u30ed\u6728\u63a2\u7d22\u306e\u5b9f\u88c5\u3001PUCT\u9078\u629e\u3001\u4e26\u5217\u5316\u6280\u8853\u306e\u8a73\u7d30\u89e3\u8aac"},a="MCTS\u5b9f\u88c5\u8a73\u7d30",d={},o=[{value:"MCTS\u306e4\u30b9\u30c6\u30c3\u30d7\u5fa9\u7fd2",id:"mcts\u306e4\u30b9\u30c6\u30c3\u30d7\u5fa9\u7fd2",level:2},{value:"\u30ce\u30fc\u30c9\u306e\u30c7\u30fc\u30bf\u69cb\u9020",id:"\u30ce\u30fc\u30c9\u306e\u30c7\u30fc\u30bf\u69cb\u9020",level:2},{value:"\u30b3\u30a2\u30c7\u30fc\u30bf",id:"\u30b3\u30a2\u30c7\u30fc\u30bf",level:3},{value:"\u30e1\u30e2\u30ea\u6700\u9069\u5316",id:"\u30e1\u30e2\u30ea\u6700\u9069\u5316",level:3},{value:"Selection\uff1aPUCT\u9078\u629e",id:"selectionpuct\u9078\u629e",level:2},{value:"PUCT\u516c\u5f0f",id:"puct\u516c\u5f0f",level:3},{value:"\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e",id:"\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e",level:3},{value:"\u5b9f\u88c5",id:"\u5b9f\u88c5",level:3},{value:"\u63a2\u7d22\u3068\u6d3b\u7528\u306e\u30d0\u30e9\u30f3\u30b9",id:"\u63a2\u7d22\u3068\u6d3b\u7528\u306e\u30d0\u30e9\u30f3\u30b9",level:3},{value:"Expansion\uff1a\u30ce\u30fc\u30c9\u5c55\u958b",id:"expansion\u30ce\u30fc\u30c9\u5c55\u958b",level:2},{value:"\u5c55\u958b\u6761\u4ef6",id:"\u5c55\u958b\u6761\u4ef6",level:3},{value:"\u5408\u6cd5\u624b\u306e\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0",id:"\u5408\u6cd5\u624b\u306e\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0",level:3},{value:"Evaluation\uff1a\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a55\u4fa1",id:"evaluation\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a55\u4fa1",level:2},{value:"\u5358\u4e00\u8a55\u4fa1",id:"\u5358\u4e00\u8a55\u4fa1",level:3},{value:"\u30d0\u30c3\u30c1\u8a55\u4fa1\uff08\u91cd\u8981\u306a\u6700\u9069\u5316\uff09",id:"\u30d0\u30c3\u30c1\u8a55\u4fa1\u91cd\u8981\u306a\u6700\u9069\u5316",level:3},{value:"Backpropagation\uff1a\u9006\u4f1d\u64ad\u66f4\u65b0",id:"backpropagation\u9006\u4f1d\u64ad\u66f4\u65b0",level:2},{value:"\u57fa\u672c\u7684\u306a\u9006\u4f1d\u64ad",id:"\u57fa\u672c\u7684\u306a\u9006\u4f1d\u64ad",level:3},{value:"\u8996\u70b9\u4ea4\u4ee3\u306e\u91cd\u8981\u6027",id:"\u8996\u70b9\u4ea4\u4ee3\u306e\u91cd\u8981\u6027",level:3},{value:"\u4e26\u5217\u5316\uff1a\u4eee\u60f3\u640d\u5931",id:"\u4e26\u5217\u5316\u4eee\u60f3\u640d\u5931",level:2},{value:"\u554f\u984c",id:"\u554f\u984c",level:3},{value:"\u89e3\u6c7a\u7b56\uff1a\u4eee\u60f3\u640d\u5931",id:"\u89e3\u6c7a\u7b56\u4eee\u60f3\u640d\u5931",level:3},{value:"\u52b9\u679c",id:"\u52b9\u679c",level:3},{value:"\u5b8c\u5168\u306a\u63a2\u7d22\u5b9f\u88c5",id:"\u5b8c\u5168\u306a\u63a2\u7d22\u5b9f\u88c5",level:2},{value:"\u9ad8\u5ea6\u306a\u6280\u8853",id:"\u9ad8\u5ea6\u306a\u6280\u8853",level:2},{value:"\u30c7\u30a3\u30ea\u30af\u30ec\u30ce\u30a4\u30ba",id:"\u30c7\u30a3\u30ea\u30af\u30ec\u30ce\u30a4\u30ba",level:3},{value:"\u6e29\u5ea6\u30d1\u30e9\u30e1\u30fc\u30bf",id:"\u6e29\u5ea6\u30d1\u30e9\u30e1\u30fc\u30bf",level:3},{value:"\u6728\u306e\u518d\u5229\u7528",id:"\u6728\u306e\u518d\u5229\u7528",level:3},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316\u306e\u307e\u3068\u3081",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316\u306e\u307e\u3068\u3081",level:2},{value:"\u95a2\u9023\u8a18\u4e8b",id:"\u95a2\u9023\u8a18\u4e8b",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"mcts\u5b9f\u88c5\u8a73\u7d30",children:"MCTS\u5b9f\u88c5\u8a73\u7d30"})}),"\n",(0,i.jsx)(n.p,{children:"\u672c\u8a18\u4e8b\u3067\u306f\u3001KataGo\u306b\u304a\u3051\u308b\u30e2\u30f3\u30c6\u30ab\u30eb\u30ed\u6728\u63a2\u7d22\uff08MCTS\uff09\u306e\u5b9f\u88c5\u8a73\u7d30\u3092\u3001\u30c7\u30fc\u30bf\u69cb\u9020\u3001\u9078\u629e\u6226\u7565\u3001\u4e26\u5217\u5316\u6280\u8853\u3092\u542b\u3081\u3066\u8a73\u3057\u304f\u89e3\u8aac\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"mcts\u306e4\u30b9\u30c6\u30c3\u30d7\u5fa9\u7fd2",children:"MCTS\u306e4\u30b9\u30c6\u30c3\u30d7\u5fa9\u7fd2"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TB\n    subgraph MCTS["MCTS\u63a2\u7d22\u30eb\u30fc\u30d7"]\n        S["1. Selection<br/>\u9078\u629e\uff1a\u6728\u3092\u4e0b\u3063\u3066\u3001PUCT\u3067\u30ce\u30fc\u30c9\u3092\u9078\u629e"]\n        S --\x3e E["2. Expansion<br/>\u5c55\u958b\uff1a\u30ea\u30fc\u30d5\u30ce\u30fc\u30c9\u306b\u5230\u9054\u3001\u5b50\u30ce\u30fc\u30c9\u3092\u4f5c\u6210"]\n        E --\x3e V["3. Evaluation<br/>\u8a55\u4fa1\uff1a\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u30ea\u30fc\u30d5\u3092\u8a55\u4fa1"]\n        V --\x3e B["4. Backprop<br/>\u9006\u4f1d\u64ad\uff1a\u7d4c\u8def\u4e0a\u306e\u5168\u30ce\u30fc\u30c9\u306e\u7d71\u8a08\u3092\u66f4\u65b0"]\n        B -.->|"\u6570\u5343\u56de\u7e70\u308a\u8fd4\u3057"| S\n    end\n    MCTS --\x3e Result["\u8a2a\u554f\u56de\u6570\u6700\u591a\u306e\u624b\u3092\u9078\u629e"]'}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30ce\u30fc\u30c9\u306e\u30c7\u30fc\u30bf\u69cb\u9020",children:"\u30ce\u30fc\u30c9\u306e\u30c7\u30fc\u30bf\u69cb\u9020"}),"\n",(0,i.jsx)(n.h3,{id:"\u30b3\u30a2\u30c7\u30fc\u30bf",children:"\u30b3\u30a2\u30c7\u30fc\u30bf"}),"\n",(0,i.jsx)(n.p,{children:"\u5404MCTS\u30ce\u30fc\u30c9\u306f\u4ee5\u4e0b\u3092\u4fdd\u5b58\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class MCTSNode:\n    def __init__(self, state, parent=None, prior=0.0):\n        # \u57fa\u672c\u60c5\u5831\n        self.state = state              # \u76e4\u9762\u72b6\u614b\n        self.parent = parent            # \u89aa\u30ce\u30fc\u30c9\n        self.children = {}              # \u5b50\u30ce\u30fc\u30c9\u8f9e\u66f8 {action: node}\n        self.action = None              # \u3053\u306e\u30ce\u30fc\u30c9\u306b\u5230\u9054\u3057\u305f\u624b\n\n        # \u7d71\u8a08\u60c5\u5831\n        self.visit_count = 0            # N(s)\uff1a\u8a2a\u554f\u56de\u6570\n        self.value_sum = 0.0            # W(s)\uff1a\u4fa1\u5024\u306e\u5408\u8a08\n        self.prior = prior              # P(s,a)\uff1a\u4e8b\u524d\u78ba\u7387\n\n        # \u4e26\u5217\u63a2\u7d22\u7528\n        self.virtual_loss = 0           # \u4eee\u60f3\u640d\u5931\n        self.is_expanded = False        # \u5c55\u958b\u6e08\u307f\u304b\u3069\u3046\u304b\n\n    @property\n    def value(self):\n        """Q(s) = W(s) / N(s)"""\n        if self.visit_count == 0:\n            return 0.0\n        return self.value_sum / self.visit_count\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u30e1\u30e2\u30ea\u6700\u9069\u5316",children:"\u30e1\u30e2\u30ea\u6700\u9069\u5316"}),"\n",(0,i.jsx)(n.p,{children:"KataGo\u306f\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u524a\u6e1b\u3059\u308b\u305f\u3081\u306b\u8907\u6570\u306e\u6280\u8853\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Python dict\u306e\u4ee3\u308f\u308a\u306bnumpy\u914d\u5217\u3092\u4f7f\u7528\nclass OptimizedNode:\n    __slots__ = ['visit_count', 'value_sum', 'prior', 'children_indices']\n\n    def __init__(self):\n        self.visit_count = np.int32(0)\n        self.value_sum = np.float32(0.0)\n        self.prior = np.float32(0.0)\n        self.children_indices = None  # \u9045\u5ef6\u5272\u308a\u5f53\u3066\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"selectionpuct\u9078\u629e",children:"Selection\uff1aPUCT\u9078\u629e"}),"\n",(0,i.jsx)(n.h3,{id:"puct\u516c\u5f0f",children:"PUCT\u516c\u5f0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u9078\u629e\u30b9\u30b3\u30a2 = Q(s,a) + U(s,a)\n\n\u3053\u3053\u3067\uff1a\nQ(s,a) = W(s,a) / N(s,a)              # \u5e73\u5747\u4fa1\u5024\nU(s,a) = c_puct \xd7 P(s,a) \xd7 \u221a(N(s)) / (1 + N(s,a))  # \u63a2\u7d22\u9805\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e",children:"\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u8a18\u53f7"}),(0,i.jsx)(n.th,{children:"\u610f\u5473"}),(0,i.jsx)(n.th,{children:"\u5178\u578b\u5024"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Q(s,a)"}),(0,i.jsx)(n.td,{children:"\u624ba\u306e\u5e73\u5747\u4fa1\u5024"}),(0,i.jsx)(n.td,{children:"[-1, +1]"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"P(s,a)"}),(0,i.jsx)(n.td,{children:"\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u4e8b\u524d\u78ba\u7387"}),(0,i.jsx)(n.td,{children:"[0, 1]"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"N(s)"}),(0,i.jsx)(n.td,{children:"\u89aa\u30ce\u30fc\u30c9\u306e\u8a2a\u554f\u56de\u6570"}),(0,i.jsx)(n.td,{children:"\u6574\u6570"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"N(s,a)"}),(0,i.jsx)(n.td,{children:"\u624ba\u306e\u8a2a\u554f\u56de\u6570"}),(0,i.jsx)(n.td,{children:"\u6574\u6570"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"c_puct"}),(0,i.jsx)(n.td,{children:"\u63a2\u7d22\u5b9a\u6570"}),(0,i.jsx)(n.td,{children:"1.0 ~ 2.5"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"\u5b9f\u88c5",children:"\u5b9f\u88c5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def select_child(self, c_puct=1.5):\n    """PUCT\u30b9\u30b3\u30a2\u6700\u5927\u306e\u5b50\u30ce\u30fc\u30c9\u3092\u9078\u629e"""\n    best_score = -float(\'inf\')\n    best_action = None\n    best_child = None\n\n    # \u89aa\u30ce\u30fc\u30c9\u306e\u8a2a\u554f\u56de\u6570\u306e\u5e73\u65b9\u6839\n    sqrt_parent_visits = math.sqrt(self.visit_count)\n\n    for action, child in self.children.items():\n        # Q\u5024\uff08\u5e73\u5747\u4fa1\u5024\uff09\n        if child.visit_count > 0:\n            q_value = child.value_sum / child.visit_count\n        else:\n            q_value = 0.0\n\n        # U\u5024\uff08\u63a2\u7d22\u9805\uff09\n        u_value = c_puct * child.prior * sqrt_parent_visits / (1 + child.visit_count)\n\n        # \u7dcf\u30b9\u30b3\u30a2\n        score = q_value + u_value\n\n        if score > best_score:\n            best_score = score\n            best_action = action\n            best_child = child\n\n    return best_action, best_child\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u63a2\u7d22\u3068\u6d3b\u7528\u306e\u30d0\u30e9\u30f3\u30b9",children:"\u63a2\u7d22\u3068\u6d3b\u7528\u306e\u30d0\u30e9\u30f3\u30b9"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u521d\u671f\uff1aN(s,a)\u304c\u5c0f\u3055\u3044\n\u251c\u2500\u2500 U(s,a)\u304c\u5927\u304d\u3044 \u2192 \u63a2\u7d22\u304c\u4e3b\u4f53\n\u2514\u2500\u2500 \u9ad8\u3044\u4e8b\u524d\u78ba\u7387\u306e\u624b\u304c\u512a\u5148\u7684\u306b\u63a2\u7d22\u3055\u308c\u308b\n\n\u5f8c\u671f\uff1aN(s,a)\u304c\u5927\u304d\u3044\n\u251c\u2500\u2500 U(s,a)\u304c\u5c0f\u3055\u3044 \u2192 \u6d3b\u7528\u304c\u4e3b\u4f53\n\u2514\u2500\u2500 Q(s,a)\u304c\u652f\u914d\u3057\u3001\u65e2\u77e5\u306e\u826f\u3044\u624b\u3092\u9078\u629e\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"expansion\u30ce\u30fc\u30c9\u5c55\u958b",children:"Expansion\uff1a\u30ce\u30fc\u30c9\u5c55\u958b"}),"\n",(0,i.jsx)(n.h3,{id:"\u5c55\u958b\u6761\u4ef6",children:"\u5c55\u958b\u6761\u4ef6"}),"\n",(0,i.jsx)(n.p,{children:"\u30ea\u30fc\u30d5\u30ce\u30fc\u30c9\u306b\u5230\u9054\u3057\u305f\u3068\u304d\u3001\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u5c55\u958b\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def expand(self, policy_probs, legal_moves):\n    """\u30ce\u30fc\u30c9\u3092\u5c55\u958b\u3057\u3001\u5168\u3066\u306e\u5408\u6cd5\u624b\u306e\u5b50\u30ce\u30fc\u30c9\u3092\u4f5c\u6210"""\n    for action in legal_moves:\n        if action not in self.children:\n            prior = policy_probs[action]  # \u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4e88\u6e2c\u306e\u78ba\u7387\n            child_state = self.state.play(action)\n            self.children[action] = MCTSNode(\n                state=child_state,\n                parent=self,\n                prior=prior\n            )\n\n    self.is_expanded = True\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u5408\u6cd5\u624b\u306e\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0",children:"\u5408\u6cd5\u624b\u306e\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def get_legal_moves(state):\n    """\u5168\u3066\u306e\u5408\u6cd5\u624b\u3092\u53d6\u5f97"""\n    legal = []\n    for i in range(361):\n        x, y = i // 19, i % 19\n        if state.is_legal(x, y):\n            legal.append(i)\n\n    # \u30d1\u30b9\u3092\u8ffd\u52a0\n    legal.append(361)\n\n    return legal\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"evaluation\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a55\u4fa1",children:"Evaluation\uff1a\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a55\u4fa1"}),"\n",(0,i.jsx)(n.h3,{id:"\u5358\u4e00\u8a55\u4fa1",children:"\u5358\u4e00\u8a55\u4fa1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def evaluate(self, state):\n    """\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u5c40\u9762\u3092\u8a55\u4fa1"""\n    # \u5165\u529b\u7279\u5fb4\u3092\u30a8\u30f3\u30b3\u30fc\u30c9\n    features = encode_state(state)  # (22, 19, 19)\n    features = torch.tensor(features).unsqueeze(0)  # (1, 22, 19, 19)\n\n    # \u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u63a8\u8ad6\n    with torch.no_grad():\n        output = self.network(features)\n\n    policy = output[\'policy\'][0].numpy()  # (362,)\n    value = output[\'value\'][0].item()     # \u30b9\u30ab\u30e9\u30fc\n\n    return policy, value\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u30d0\u30c3\u30c1\u8a55\u4fa1\u91cd\u8981\u306a\u6700\u9069\u5316",children:"\u30d0\u30c3\u30c1\u8a55\u4fa1\uff08\u91cd\u8981\u306a\u6700\u9069\u5316\uff09"}),"\n",(0,i.jsx)(n.p,{children:"GPU\u306f\u30d0\u30c3\u30c1\u63a8\u8ad6\u3067\u6700\u3082\u52b9\u7387\u7684\u3067\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class BatchedEvaluator:\n    def __init__(self, network, batch_size=8):\n        self.network = network\n        self.batch_size = batch_size\n        self.pending = []  # \u8a55\u4fa1\u5f85\u3061\u306e (state, callback) \u30ea\u30b9\u30c8\n\n    def request_evaluation(self, state, callback):\n        """\u8a55\u4fa1\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u3001\u30d0\u30c3\u30c1\u304c\u6e80\u305f\u3055\u308c\u305f\u3089\u81ea\u52d5\u5b9f\u884c"""\n        self.pending.append((state, callback))\n\n        if len(self.pending) >= self.batch_size:\n            self.flush()\n\n    def flush(self):\n        """\u30d0\u30c3\u30c1\u8a55\u4fa1\u3092\u5b9f\u884c"""\n        if not self.pending:\n            return\n\n        # \u30d0\u30c3\u30c1\u5165\u529b\u3092\u6e96\u5099\n        states = [s for s, _ in self.pending]\n        features = torch.stack([encode_state(s) for s in states])\n\n        # \u30d0\u30c3\u30c1\u63a8\u8ad6\n        with torch.no_grad():\n            outputs = self.network(features)\n\n        # \u7d50\u679c\u3092\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\n        for i, (_, callback) in enumerate(self.pending):\n            policy = outputs[\'policy\'][i].numpy()\n            value = outputs[\'value\'][i].item()\n            callback(policy, value)\n\n        self.pending.clear()\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"backpropagation\u9006\u4f1d\u64ad\u66f4\u65b0",children:"Backpropagation\uff1a\u9006\u4f1d\u64ad\u66f4\u65b0"}),"\n",(0,i.jsx)(n.h3,{id:"\u57fa\u672c\u7684\u306a\u9006\u4f1d\u64ad",children:"\u57fa\u672c\u7684\u306a\u9006\u4f1d\u64ad"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def backpropagate(self, value):\n    """\u30ea\u30fc\u30d5\u30ce\u30fc\u30c9\u304b\u3089\u30eb\u30fc\u30c8\u30ce\u30fc\u30c9\u307e\u3067\u9006\u4f1d\u64ad\u3057\u3001\u7d71\u8a08\u60c5\u5831\u3092\u66f4\u65b0"""\n    node = self\n\n    while node is not None:\n        node.visit_count += 1\n        node.value_sum += value\n\n        # \u8996\u70b9\u306e\u4ea4\u4ee3\uff1a\u76f8\u624b\u306e\u4fa1\u5024\u306f\u9006\u306b\u306a\u308b\n        value = -value\n\n        node = node.parent\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u8996\u70b9\u4ea4\u4ee3\u306e\u91cd\u8981\u6027",children:"\u8996\u70b9\u4ea4\u4ee3\u306e\u91cd\u8981\u6027"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u9ed2\u306e\u8996\u70b9\uff1avalue = +0.6\uff08\u9ed2\u6709\u5229\uff09\n\n\u9006\u4f1d\u64ad\u7d4c\u8def\uff1a\n\u30ea\u30fc\u30d5\u30ce\u30fc\u30c9\uff08\u9ed2\u306e\u624b\u756a\uff09: value_sum += +0.6\n    \u2191\n\u89aa\u30ce\u30fc\u30c9\uff08\u767d\u306e\u624b\u756a\uff09: value_sum += -0.6  \u2190 \u767d\u306b\u3068\u3063\u3066\u306f\u4e0d\u5229\n    \u2191\n\u7956\u7236\u30ce\u30fc\u30c9\uff08\u9ed2\u306e\u624b\u756a\uff09: value_sum += +0.6\n    \u2191\n...\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u4e26\u5217\u5316\u4eee\u60f3\u640d\u5931",children:"\u4e26\u5217\u5316\uff1a\u4eee\u60f3\u640d\u5931"}),"\n",(0,i.jsx)(n.h3,{id:"\u554f\u984c",children:"\u554f\u984c"}),"\n",(0,i.jsx)(n.p,{children:"\u30de\u30eb\u30c1\u30b9\u30ec\u30c3\u30c9\u3067\u540c\u6642\u63a2\u7d22\u3059\u308b\u3068\u3001\u5168\u3066\u540c\u3058\u30ce\u30fc\u30c9\u3092\u9078\u629e\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Thread 1: \u30ce\u30fc\u30c9A\u3092\u9078\u629e\uff08Q=0.6, N=100\uff09\nThread 2: \u30ce\u30fc\u30c9A\u3092\u9078\u629e\uff08Q=0.6, N=100\uff09\u2190 \u91cd\u8907\uff01\nThread 3: \u30ce\u30fc\u30c9A\u3092\u9078\u629e\uff08Q=0.6, N=100\uff09\u2190 \u91cd\u8907\uff01\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89e3\u6c7a\u7b56\u4eee\u60f3\u640d\u5931",children:"\u89e3\u6c7a\u7b56\uff1a\u4eee\u60f3\u640d\u5931"}),"\n",(0,i.jsx)(n.p,{children:"\u30ce\u30fc\u30c9\u9078\u629e\u6642\u306b\u3001\u307e\u305a\u300c\u4eee\u60f3\u640d\u5931\u300d\u3092\u8ffd\u52a0\u3057\u3066\u3001\u4ed6\u306e\u30b9\u30ec\u30c3\u30c9\u304c\u305d\u308c\u3092\u9078\u3073\u305f\u304f\u306a\u304f\u306a\u308b\u3088\u3046\u306b\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'VIRTUAL_LOSS = 3  # \u4eee\u60f3\u640d\u5931\u5024\n\ndef select_with_virtual_loss(self):\n    """\u4eee\u60f3\u640d\u5931\u4ed8\u304d\u306e\u9078\u629e"""\n    action, child = self.select_child()\n\n    # \u4eee\u60f3\u640d\u5931\u3092\u8ffd\u52a0\n    child.visit_count += VIRTUAL_LOSS\n    child.value_sum -= VIRTUAL_LOSS  # \u8ca0\u3051\u305f\u3068\u4eee\u5b9a\n\n    return action, child\n\ndef backpropagate_with_virtual_loss(self, value):\n    """\u9006\u4f1d\u64ad\u6642\u306b\u4eee\u60f3\u640d\u5931\u3092\u9664\u53bb"""\n    node = self\n\n    while node is not None:\n        # \u4eee\u60f3\u640d\u5931\u3092\u9664\u53bb\n        node.visit_count -= VIRTUAL_LOSS\n        node.value_sum += VIRTUAL_LOSS\n\n        # \u901a\u5e38\u306e\u66f4\u65b0\n        node.visit_count += 1\n        node.value_sum += value\n\n        value = -value\n        node = node.parent\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u52b9\u679c",children:"\u52b9\u679c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Thread 1: \u30ce\u30fc\u30c9A\u3092\u9078\u629e\u3001\u4eee\u60f3\u640d\u5931\u3092\u8ffd\u52a0\n         A\u306e Q\u5024\u304c\u4e00\u6642\u7684\u306b\u4f4e\u4e0b\n\nThread 2: \u30ce\u30fc\u30c9B\u3092\u9078\u629e\uff08A\u304c\u60aa\u304f\u898b\u3048\u308b\u305f\u3081\uff09\n\nThread 3: \u30ce\u30fc\u30c9C\u3092\u9078\u629e\n\n\u2192 \u7570\u306a\u308b\u30b9\u30ec\u30c3\u30c9\u304c\u7570\u306a\u308b\u5206\u5c90\u3092\u63a2\u7d22\u3057\u3001\u52b9\u7387\u304c\u5411\u4e0a\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u5b8c\u5168\u306a\u63a2\u7d22\u5b9f\u88c5",children:"\u5b8c\u5168\u306a\u63a2\u7d22\u5b9f\u88c5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class MCTS:\n    def __init__(self, network, c_puct=1.5, num_simulations=800):\n        self.network = network\n        self.c_puct = c_puct\n        self.num_simulations = num_simulations\n        self.evaluator = BatchedEvaluator(network)\n\n    def search(self, root_state):\n        """MCTS\u63a2\u7d22\u3092\u5b9f\u884c"""\n        root = MCTSNode(root_state)\n\n        # \u30eb\u30fc\u30c8\u30ce\u30fc\u30c9\u3092\u5c55\u958b\n        policy, value = self.evaluate(root_state)\n        legal_moves = get_legal_moves(root_state)\n        root.expand(policy, legal_moves)\n\n        # \u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\n        for _ in range(self.num_simulations):\n            node = root\n            path = [node]\n\n            # Selection\uff1a\u6728\u3092\u4e0b\u308b\n            while node.is_expanded and node.children:\n                action, node = node.select_child(self.c_puct)\n                path.append(node)\n\n            # Expansion + Evaluation\n            if not node.is_expanded:\n                policy, value = self.evaluate(node.state)\n                legal_moves = get_legal_moves(node.state)\n\n                if legal_moves:\n                    node.expand(policy, legal_moves)\n\n            # Backpropagation\n            for n in reversed(path):\n                n.visit_count += 1\n                n.value_sum += value\n                value = -value\n\n        # \u8a2a\u554f\u56de\u6570\u6700\u591a\u306e\u624b\u3092\u9078\u629e\n        best_action = max(root.children.items(),\n                         key=lambda x: x[1].visit_count)[0]\n\n        return best_action\n\n    def evaluate(self, state):\n        features = encode_state(state)\n        features = torch.tensor(features).unsqueeze(0)\n\n        with torch.no_grad():\n            output = self.network(features)\n\n        return output[\'policy\'][0].numpy(), output[\'value\'][0].item()\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u9ad8\u5ea6\u306a\u6280\u8853",children:"\u9ad8\u5ea6\u306a\u6280\u8853"}),"\n",(0,i.jsx)(n.h3,{id:"\u30c7\u30a3\u30ea\u30af\u30ec\u30ce\u30a4\u30ba",children:"\u30c7\u30a3\u30ea\u30af\u30ec\u30ce\u30a4\u30ba"}),"\n",(0,i.jsx)(n.p,{children:"\u8a13\u7df4\u6642\u306b\u30eb\u30fc\u30c8\u30ce\u30fc\u30c9\u306b\u30ce\u30a4\u30ba\u3092\u8ffd\u52a0\u3057\u3066\u63a2\u7d22\u3092\u5897\u3084\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def add_dirichlet_noise(root, alpha=0.03, epsilon=0.25):\n    """\u30eb\u30fc\u30c8\u30ce\u30fc\u30c9\u306b\u30c7\u30a3\u30ea\u30af\u30ec\u30ce\u30a4\u30ba\u3092\u8ffd\u52a0"""\n    noise = np.random.dirichlet([alpha] * len(root.children))\n\n    for i, child in enumerate(root.children.values()):\n        child.prior = (1 - epsilon) * child.prior + epsilon * noise[i]\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6e29\u5ea6\u30d1\u30e9\u30e1\u30fc\u30bf",children:"\u6e29\u5ea6\u30d1\u30e9\u30e1\u30fc\u30bf"}),"\n",(0,i.jsx)(n.p,{children:"\u624b\u306e\u9078\u629e\u306e\u30e9\u30f3\u30c0\u30e0\u6027\u3092\u5236\u5fa1\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def select_action_with_temperature(root, temperature=1.0):\n    """\u8a2a\u554f\u56de\u6570\u3068\u6e29\u5ea6\u306b\u57fa\u3065\u3044\u3066\u624b\u3092\u9078\u629e"""\n    visits = np.array([c.visit_count for c in root.children.values()])\n    actions = list(root.children.keys())\n\n    if temperature == 0:\n        # \u8caa\u6b32\u9078\u629e\n        return actions[np.argmax(visits)]\n    else:\n        # \u8a2a\u554f\u56de\u6570\u306e\u78ba\u7387\u5206\u5e03\u306b\u57fa\u3065\u3044\u3066\u9078\u629e\n        probs = visits ** (1 / temperature)\n        probs = probs / probs.sum()\n        return np.random.choice(actions, p=probs)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6728\u306e\u518d\u5229\u7528",children:"\u6728\u306e\u518d\u5229\u7528"}),"\n",(0,i.jsx)(n.p,{children:"\u65b0\u3057\u3044\u624b\u3067\u4ee5\u524d\u306e\u63a2\u7d22\u6728\u3092\u518d\u5229\u7528\u3067\u304d\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def reuse_tree(root, action):\n    """\u90e8\u5206\u6728\u3092\u518d\u5229\u7528"""\n    if action in root.children:\n        new_root = root.children[action]\n        new_root.parent = None\n        return new_root\n    else:\n        return None  # \u65b0\u3057\u3044\u6728\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u3042\u308a\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316\u306e\u307e\u3068\u3081",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316\u306e\u307e\u3068\u3081"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u6280\u8853"}),(0,i.jsx)(n.th,{children:"\u52b9\u679c"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u30d0\u30c3\u30c1\u8a55\u4fa1"})}),(0,i.jsx)(n.td,{children:"GPU\u4f7f\u7528\u7387\u304c10% \u2192 80%\u4ee5\u4e0a\u306b"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u4eee\u60f3\u640d\u5931"})}),(0,i.jsx)(n.td,{children:"\u30de\u30eb\u30c1\u30b9\u30ec\u30c3\u30c9\u52b9\u7387\u304c3-5\u500d\u5411\u4e0a"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u6728\u306e\u518d\u5229\u7528"})}),(0,i.jsx)(n.td,{children:"\u30b3\u30fc\u30eb\u30c9\u30b9\u30bf\u30fc\u30c8\u3092\u524a\u6e1b\u3001\u8a08\u7b97\u309230%\u4ee5\u4e0a\u7bc0\u7d04"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u30e1\u30e2\u30ea\u30d7\u30fc\u30eb"})}),(0,i.jsx)(n.td,{children:"\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u3092\u524a\u6e1b"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u95a2\u9023\u8a18\u4e8b",children:"\u95a2\u9023\u8a18\u4e8b"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../neural-network",children:"\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a73\u89e3"})," \u2014 \u8a55\u4fa1\u95a2\u6570\u306e\u5143"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../gpu-optimization",children:"GPU\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u6700\u9069\u5316"})," \u2014 \u30d0\u30c3\u30c1\u63a8\u8ad6\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u6700\u9069\u5316"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../papers",children:"\u91cd\u8981\u8ad6\u6587\u30ac\u30a4\u30c9"})," \u2014 PUCT\u516c\u5f0f\u306e\u7406\u8ad6\u7684\u57fa\u790e"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},30416(e,n,s){s.d(n,{R:()=>r,x:()=>a});var l=s(59471);const i={},t=l.createContext(i);function r(e){const n=l.useContext(t);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),l.createElement(t.Provider,{value:n},e.children)}}}]);