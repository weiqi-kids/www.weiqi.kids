"use strict";(globalThis.webpackChunktemp_docusaurus=globalThis.webpackChunktemp_docusaurus||[]).push([[5878],{82761(e,n,i){i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"for-engineers/deep-dive/quantization-deploy","title":"\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8","description":"KataGo\u30e2\u30c7\u30eb\u306e\u91cf\u5b50\u5316\u6280\u8853\u3001\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3001\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/for-engineers/deep-dive/quantization-deploy.md","sourceDirName":"for-engineers/deep-dive","slug":"/for-engineers/deep-dive/quantization-deploy","permalink":"/ja/docs/for-engineers/deep-dive/quantization-deploy","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/for-engineers/deep-dive/quantization-deploy.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8","description":"KataGo\u30e2\u30c7\u30eb\u306e\u91cf\u5b50\u5316\u6280\u8853\u3001\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3001\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3"},"sidebar":"tutorialSidebar","previous":{"title":"\u5206\u6563\u8a13\u7df4\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3","permalink":"/ja/docs/for-engineers/deep-dive/distributed-training"},"next":{"title":"\u8a55\u4fa1\u3068\u30d9\u30f3\u30c1\u30de\u30fc\u30af","permalink":"/ja/docs/for-engineers/deep-dive/evaluation"}}');var t=i(62615),r=i(30416);const d={sidebar_position:8,title:"\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",description:"KataGo\u30e2\u30c7\u30eb\u306e\u91cf\u5b50\u5316\u6280\u8853\u3001\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3001\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3"},l="\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",a={},o=[{value:"\u91cf\u5b50\u5316\u6280\u8853\u306e\u6982\u8981",id:"\u91cf\u5b50\u5316\u6280\u8853\u306e\u6982\u8981",level:2},{value:"\u306a\u305c\u91cf\u5b50\u5316\u304c\u5fc5\u8981\u304b\uff1f",id:"\u306a\u305c\u91cf\u5b50\u5316\u304c\u5fc5\u8981\u304b",level:3},{value:"\u91cf\u5b50\u5316\u306e\u7a2e\u985e",id:"\u91cf\u5b50\u5316\u306e\u7a2e\u985e",level:3},{value:"FP16\u534a\u7cbe\u5ea6",id:"fp16\u534a\u7cbe\u5ea6",level:2},{value:"\u6982\u5ff5",id:"\u6982\u5ff5",level:3},{value:"KataGo\u8a2d\u5b9a",id:"katago\u8a2d\u5b9a",level:3},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff",level:3},{value:"INT8\u91cf\u5b50\u5316",id:"int8\u91cf\u5b50\u5316",level:2},{value:"\u91cf\u5b50\u5316\u30d5\u30ed\u30fc",id:"\u91cf\u5b50\u5316\u30d5\u30ed\u30fc",level:3},{value:"\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf",id:"\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf",level:3},{value:"\u6ce8\u610f\u4e8b\u9805",id:"\u6ce8\u610f\u4e8b\u9805",level:3},{value:"TensorRT\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",id:"tensorrt\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",level:2},{value:"\u5909\u63db\u30d5\u30ed\u30fc",id:"\u5909\u63db\u30d5\u30ed\u30fc",level:3},{value:"TensorRT\u30a8\u30f3\u30b8\u30f3\u306e\u4f7f\u7528",id:"tensorrt\u30a8\u30f3\u30b8\u30f3\u306e\u4f7f\u7528",level:3},{value:"ONNX\u30a8\u30af\u30b9\u30dd\u30fc\u30c8",id:"onnx\u30a8\u30af\u30b9\u30dd\u30fc\u30c8",level:2},{value:"PyTorch \u2192 ONNX",id:"pytorch--onnx",level:3},{value:"ONNX\u30e2\u30c7\u30eb\u306e\u691c\u8a3c",id:"onnx\u30e2\u30c7\u30eb\u306e\u691c\u8a3c",level:3},{value:"\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4",id:"\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4",level:2},{value:"\u30b5\u30fc\u30d0\u30fc\u30c7\u30d7\u30ed\u30a4",id:"\u30b5\u30fc\u30d0\u30fc\u30c7\u30d7\u30ed\u30a4",level:3},{value:"\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u30a2\u30d7\u30ea\u7d71\u5408",id:"\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u30a2\u30d7\u30ea\u7d71\u5408",level:3},{value:"\u30e2\u30d0\u30a4\u30eb\u30c7\u30d7\u30ed\u30a4",id:"\u30e2\u30d0\u30a4\u30eb\u30c7\u30d7\u30ed\u30a4",level:3},{value:"iOS\uff08Core ML\uff09",id:"ioscore-ml",level:4},{value:"Android\uff08TensorFlow Lite\uff09",id:"androidtensorflow-lite",level:4},{value:"\u7d44\u307f\u8fbc\u307f\u30b7\u30b9\u30c6\u30e0",id:"\u7d44\u307f\u8fbc\u307f\u30b7\u30b9\u30c6\u30e0",level:3},{value:"Raspberry Pi",id:"raspberry-pi",level:4},{value:"NVIDIA Jetson",id:"nvidia-jetson",level:4},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",level:2},{value:"\u5404\u30c7\u30d7\u30ed\u30a4\u65b9\u5f0f\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9",id:"\u5404\u30c7\u30d7\u30ed\u30a4\u65b9\u5f0f\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9",level:3},{value:"\u30e2\u30c7\u30eb\u30b5\u30a4\u30ba\u6bd4\u8f03",id:"\u30e2\u30c7\u30eb\u30b5\u30a4\u30ba\u6bd4\u8f03",level:3},{value:"\u30c7\u30d7\u30ed\u30a4\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",id:"\u30c7\u30d7\u30ed\u30a4\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",level:2},{value:"\u95a2\u9023\u8a18\u4e8b",id:"\u95a2\u9023\u8a18\u4e8b",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",input:"input",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",children:"\u30e2\u30c7\u30eb\u91cf\u5b50\u5316\u3068\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8"})}),"\n",(0,t.jsx)(n.p,{children:"\u672c\u8a18\u4e8b\u3067\u306f\u3001KataGo\u30e2\u30c7\u30eb\u306e\u91cf\u5b50\u5316\u306b\u3088\u308b\u30ea\u30bd\u30fc\u30b9\u524a\u6e1b\u65b9\u6cd5\u3068\u3001\u5404\u7a2e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\u91cf\u5b50\u5316\u6280\u8853\u306e\u6982\u8981",children:"\u91cf\u5b50\u5316\u6280\u8853\u306e\u6982\u8981"}),"\n",(0,t.jsx)(n.h3,{id:"\u306a\u305c\u91cf\u5b50\u5316\u304c\u5fc5\u8981\u304b",children:"\u306a\u305c\u91cf\u5b50\u5316\u304c\u5fc5\u8981\u304b\uff1f"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u7cbe\u5ea6"}),(0,t.jsx)(n.th,{children:"\u30b5\u30a4\u30ba"}),(0,t.jsx)(n.th,{children:"\u901f\u5ea6"}),(0,t.jsx)(n.th,{children:"\u7cbe\u5ea6\u640d\u5931"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"FP32"}),(0,t.jsx)(n.td,{children:"100%"}),(0,t.jsx)(n.td,{children:"\u57fa\u6e96"}),(0,t.jsx)(n.td,{children:"0%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"FP16"}),(0,t.jsx)(n.td,{children:"50%"}),(0,t.jsx)(n.td,{children:"+50%"}),(0,t.jsx)(n.td,{children:"~0%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"INT8"}),(0,t.jsx)(n.td,{children:"25%"}),(0,t.jsx)(n.td,{children:"+100%"}),(0,t.jsx)(n.td,{children:"<1%"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"\u91cf\u5b50\u5316\u306e\u7a2e\u985e",children:"\u91cf\u5b50\u5316\u306e\u7a2e\u985e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u8a13\u7df4\u5f8c\u91cf\u5b50\u5316\uff08PTQ\uff09\n\u251c\u2500\u2500 \u7c21\u5358\u3067\u9ad8\u901f\n\u251c\u2500\u2500 \u518d\u8a13\u7df4\u4e0d\u8981\n\u2514\u2500\u2500 \u7cbe\u5ea6\u640d\u5931\u306e\u53ef\u80fd\u6027\u3042\u308a\n\n\u91cf\u5b50\u5316\u8a8d\u8b58\u8a13\u7df4\uff08QAT\uff09\n\u251c\u2500\u2500 \u3088\u308a\u9ad8\u3044\u7cbe\u5ea6\n\u251c\u2500\u2500 \u518d\u8a13\u7df4\u304c\u5fc5\u8981\n\u2514\u2500\u2500 \u3088\u308a\u8907\u96d1\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"fp16\u534a\u7cbe\u5ea6",children:"FP16\u534a\u7cbe\u5ea6"}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u5ff5",children:"\u6982\u5ff5"}),"\n",(0,t.jsx)(n.p,{children:"32\u30d3\u30c3\u30c8\u6d6e\u52d5\u5c0f\u6570\u70b9\u309216\u30d3\u30c3\u30c8\u306b\u5909\u63db\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# FP32 \u2192 FP16\u5909\u63db\nmodel_fp16 = model.half()\n\n# \u63a8\u8ad6\nwith torch.cuda.amp.autocast():\n    output = model_fp16(input.half())\n"})}),"\n",(0,t.jsx)(n.h3,{id:"katago\u8a2d\u5b9a",children:"KataGo\u8a2d\u5b9a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",children:"# config.cfg\nuseFP16 = true           # FP16\u63a8\u8ad6\u3092\u6709\u52b9\u5316\nuseFP16Storage = true    # FP16\u3067\u4e2d\u9593\u7d50\u679c\u3092\u4fdd\u5b58\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"GPU\u30b7\u30ea\u30fc\u30ba"}),(0,t.jsx)(n.th,{children:"FP16\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30b7\u30e7\u30f3"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"GTX 10xx"}),(0,t.jsx)(n.td,{children:"\u306a\u3057\uff08Tensor Core\u306a\u3057\uff09"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"RTX 20xx"}),(0,t.jsx)(n.td,{children:"+30-50%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"RTX 30xx"}),(0,t.jsx)(n.td,{children:"+50-80%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"RTX 40xx"}),(0,t.jsx)(n.td,{children:"+80-100%"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"int8\u91cf\u5b50\u5316",children:"INT8\u91cf\u5b50\u5316"}),"\n",(0,t.jsx)(n.h3,{id:"\u91cf\u5b50\u5316\u30d5\u30ed\u30fc",children:"\u91cf\u5b50\u5316\u30d5\u30ed\u30fc"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import torch.quantization as quant\n\n# 1. \u30e2\u30c7\u30eb\u3092\u6e96\u5099\nmodel.eval()\nmodel.qconfig = quant.get_default_qconfig('fbgemm')\n\n# 2. \u91cf\u5b50\u5316\u3092\u6e96\u5099\nmodel_prepared = quant.prepare(model)\n\n# 3. \u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\uff08\u4ee3\u8868\u7684\u306a\u30c7\u30fc\u30bf\u3092\u4f7f\u7528\uff09\nwith torch.no_grad():\n    for data in calibration_loader:\n        model_prepared(data)\n\n# 4. \u91cf\u5b50\u5316\u30e2\u30c7\u30eb\u306b\u5909\u63db\nmodel_quantized = quant.convert(model_prepared)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf",children:"\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'def create_calibration_dataset(num_samples=1000):\n    """\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3092\u4f5c\u6210"""\n    samples = []\n\n    # \u5b9f\u969b\u306e\u5bfe\u5c40\u304b\u3089\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\n    for game in random_games(num_samples):\n        position = random_position(game)\n        features = encode_state(position)\n        samples.append(features)\n\n    return samples\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6ce8\u610f\u4e8b\u9805",children:"\u6ce8\u610f\u4e8b\u9805"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"INT8\u91cf\u5b50\u5316\u306b\u306f\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf\u304c\u5fc5\u8981"}),"\n",(0,t.jsx)(n.li,{children:"\u4e00\u90e8\u306e\u30ec\u30a4\u30e4\u30fc\u306f\u91cf\u5b50\u5316\u306b\u9069\u3055\u306a\u3044\u5834\u5408\u304c\u3042\u308b"}),"\n",(0,t.jsx)(n.li,{children:"\u7cbe\u5ea6\u640d\u5931\u306e\u30c6\u30b9\u30c8\u304c\u5fc5\u8981"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"tensorrt\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8",children:"TensorRT\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8"}),"\n",(0,t.jsx)(n.h3,{id:"\u5909\u63db\u30d5\u30ed\u30fc",children:"\u5909\u63db\u30d5\u30ed\u30fc"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import tensorrt as trt\n\ndef convert_to_tensorrt(onnx_path, engine_path):\n    logger = trt.Logger(trt.Logger.WARNING)\n    builder = trt.Builder(logger)\n    network = builder.create_network(\n        1 << int(trt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH)\n    )\n    parser = trt.OnnxParser(network, logger)\n\n    # ONNX\u30e2\u30c7\u30eb\u3092\u89e3\u6790\n    with open(onnx_path, 'rb') as f:\n        parser.parse(f.read())\n\n    # \u6700\u9069\u5316\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\n    config = builder.create_builder_config()\n    config.max_workspace_size = 1 << 30  # 1GB\n\n    # FP16\u3092\u6709\u52b9\u5316\n    config.set_flag(trt.BuilderFlag.FP16)\n\n    # \u30a8\u30f3\u30b8\u30f3\u3092\u69cb\u7bc9\n    engine = builder.build_engine(network, config)\n\n    # \u4fdd\u5b58\n    with open(engine_path, 'wb') as f:\n        f.write(engine.serialize())\n"})}),"\n",(0,t.jsx)(n.h3,{id:"tensorrt\u30a8\u30f3\u30b8\u30f3\u306e\u4f7f\u7528",children:"TensorRT\u30a8\u30f3\u30b8\u30f3\u306e\u4f7f\u7528"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"def inference_with_tensorrt(engine_path, input_data):\n    # \u30a8\u30f3\u30b8\u30f3\u3092\u30ed\u30fc\u30c9\n    with open(engine_path, 'rb') as f:\n        engine = trt.Runtime(logger).deserialize_cuda_engine(f.read())\n\n    context = engine.create_execution_context()\n\n    # \u30e1\u30e2\u30ea\u3092\u5272\u308a\u5f53\u3066\n    d_input = cuda.mem_alloc(input_data.nbytes)\n    d_output = cuda.mem_alloc(output_size)\n\n    # \u5165\u529b\u3092\u30b3\u30d4\u30fc\n    cuda.memcpy_htod(d_input, input_data)\n\n    # \u63a8\u8ad6\u3092\u5b9f\u884c\n    context.execute_v2([int(d_input), int(d_output)])\n\n    # \u51fa\u529b\u3092\u53d6\u5f97\n    output = np.empty(output_shape, dtype=np.float32)\n    cuda.memcpy_dtoh(output, d_output)\n\n    return output\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"onnx\u30a8\u30af\u30b9\u30dd\u30fc\u30c8",children:"ONNX\u30a8\u30af\u30b9\u30dd\u30fc\u30c8"}),"\n",(0,t.jsx)(n.h3,{id:"pytorch--onnx",children:"PyTorch \u2192 ONNX"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import torch.onnx\n\ndef export_to_onnx(model, output_path):\n    model.eval()\n\n    # \u30b5\u30f3\u30d7\u30eb\u5165\u529b\u3092\u4f5c\u6210\n    dummy_input = torch.randn(1, 22, 19, 19)\n\n    # \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\n    torch.onnx.export(\n        model,\n        dummy_input,\n        output_path,\n        input_names=['input'],\n        output_names=['policy', 'value', 'ownership'],\n        dynamic_axes={\n            'input': {0: 'batch_size'},\n            'policy': {0: 'batch_size'},\n            'value': {0: 'batch_size'},\n            'ownership': {0: 'batch_size'}\n        },\n        opset_version=13\n    )\n"})}),"\n",(0,t.jsx)(n.h3,{id:"onnx\u30e2\u30c7\u30eb\u306e\u691c\u8a3c",children:"ONNX\u30e2\u30c7\u30eb\u306e\u691c\u8a3c"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import onnx\nimport onnxruntime as ort\n\n# \u30e2\u30c7\u30eb\u69cb\u9020\u3092\u691c\u8a3c\nmodel = onnx.load("model.onnx")\nonnx.checker.check_model(model)\n\n# \u63a8\u8ad6\u3092\u30c6\u30b9\u30c8\nsession = ort.InferenceSession("model.onnx")\noutput = session.run(None, {\'input\': input_data})\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4",children:"\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3078\u306e\u30c7\u30d7\u30ed\u30a4"}),"\n",(0,t.jsx)(n.h3,{id:"\u30b5\u30fc\u30d0\u30fc\u30c7\u30d7\u30ed\u30a4",children:"\u30b5\u30fc\u30d0\u30fc\u30c7\u30d7\u30ed\u30a4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# docker-compose.yml\nversion: '3'\nservices:\n  katago:\n    image: katago/katago:latest\n    deploy:\n      resources:\n        reservations:\n          devices:\n            - driver: nvidia\n              count: 1\n              capabilities: [gpu]\n    volumes:\n      - ./models:/models\n      - ./config:/config\n    command: >\n      katago analysis\n      -model /models/kata-b18c384.bin.gz\n      -config /config/analysis.cfg\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u30a2\u30d7\u30ea\u7d71\u5408",children:"\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u30a2\u30d7\u30ea\u7d71\u5408"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# KataGo\u3092Python\u30a2\u30d7\u30ea\u306b\u57cb\u3081\u8fbc\u3080\nimport subprocess\nimport json\n\nclass KataGoProcess:\n    def __init__(self, katago_path, model_path):\n        self.process = subprocess.Popen(\n            [katago_path, 'analysis', '-model', model_path],\n            stdin=subprocess.PIPE,\n            stdout=subprocess.PIPE,\n            text=True\n        )\n\n    def analyze(self, moves):\n        query = {\n            'id': 'query1',\n            'moves': moves,\n            'rules': 'chinese',\n            'komi': 7.5,\n            'boardXSize': 19,\n            'boardYSize': 19\n        }\n        self.process.stdin.write(json.dumps(query) + '\\n')\n        self.process.stdin.flush()\n\n        response = self.process.stdout.readline()\n        return json.loads(response)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u30e2\u30d0\u30a4\u30eb\u30c7\u30d7\u30ed\u30a4",children:"\u30e2\u30d0\u30a4\u30eb\u30c7\u30d7\u30ed\u30a4"}),"\n",(0,t.jsx)(n.h4,{id:"ioscore-ml",children:"iOS\uff08Core ML\uff09"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import coremltools as ct\n\n# Core ML\u306b\u5909\u63db\nmlmodel = ct.convert(\n    model,\n    inputs=[ct.TensorType(shape=(1, 22, 19, 19))],\n    minimum_deployment_target=ct.target.iOS15\n)\n\nmlmodel.save("KataGo.mlmodel")\n'})}),"\n",(0,t.jsx)(n.h4,{id:"androidtensorflow-lite",children:"Android\uff08TensorFlow Lite\uff09"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import tensorflow as tf\n\n# TFLite\u306b\u5909\u63db\nconverter = tf.lite.TFLiteConverter.from_saved_model(model_path)\nconverter.optimizations = [tf.lite.Optimize.DEFAULT]\nconverter.target_spec.supported_types = [tf.float16]\n\ntflite_model = converter.convert()\n\nwith open('katago.tflite', 'wb') as f:\n    f.write(tflite_model)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u7d44\u307f\u8fbc\u307f\u30b7\u30b9\u30c6\u30e0",children:"\u7d44\u307f\u8fbc\u307f\u30b7\u30b9\u30c6\u30e0"}),"\n",(0,t.jsx)(n.h4,{id:"raspberry-pi",children:"Raspberry Pi"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Eigen\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\uff08CPU\u5c02\u7528\uff09\n./katago gtp -model kata-b10c128.bin.gz -config rpi.cfg\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",children:"# rpi.cfg - Raspberry Pi\u6700\u9069\u5316\u8a2d\u5b9a\nnumSearchThreads = 4\nmaxVisits = 100\nnnMaxBatchSize = 1\n"})}),"\n",(0,t.jsx)(n.h4,{id:"nvidia-jetson",children:"NVIDIA Jetson"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# CUDA\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\n./katago gtp -model kata-b18c384.bin.gz -config jetson.cfg\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03"}),"\n",(0,t.jsx)(n.h3,{id:"\u5404\u30c7\u30d7\u30ed\u30a4\u65b9\u5f0f\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9",children:"\u5404\u30c7\u30d7\u30ed\u30a4\u65b9\u5f0f\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u30c7\u30d7\u30ed\u30a4\u65b9\u5f0f"}),(0,t.jsx)(n.th,{children:"\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2"}),(0,t.jsx)(n.th,{children:"Playouts/\u79d2"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CUDA FP32"}),(0,t.jsx)(n.td,{children:"RTX 3080"}),(0,t.jsx)(n.td,{children:"~3000"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CUDA FP16"}),(0,t.jsx)(n.td,{children:"RTX 3080"}),(0,t.jsx)(n.td,{children:"~5000"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"TensorRT FP16"}),(0,t.jsx)(n.td,{children:"RTX 3080"}),(0,t.jsx)(n.td,{children:"~6500"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"OpenCL"}),(0,t.jsx)(n.td,{children:"M1 Pro"}),(0,t.jsx)(n.td,{children:"~1500"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Core ML"}),(0,t.jsx)(n.td,{children:"M1 Pro"}),(0,t.jsx)(n.td,{children:"~1800"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"TFLite"}),(0,t.jsx)(n.td,{children:"Pixel 7"}),(0,t.jsx)(n.td,{children:"~50"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Eigen"}),(0,t.jsx)(n.td,{children:"RPi 4"}),(0,t.jsx)(n.td,{children:"~15"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"\u30e2\u30c7\u30eb\u30b5\u30a4\u30ba\u6bd4\u8f03",children:"\u30e2\u30c7\u30eb\u30b5\u30a4\u30ba\u6bd4\u8f03"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u30d5\u30a9\u30fc\u30de\u30c3\u30c8"}),(0,t.jsx)(n.th,{children:"b18c384\u30b5\u30a4\u30ba"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u30aa\u30ea\u30b8\u30ca\u30eb (.bin.gz)"}),(0,t.jsx)(n.td,{children:"~140 MB"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ONNX FP32"}),(0,t.jsx)(n.td,{children:"~280 MB"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ONNX FP16"}),(0,t.jsx)(n.td,{children:"~140 MB"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"TensorRT FP16"}),(0,t.jsx)(n.td,{children:"~100 MB"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"TFLite FP16"}),(0,t.jsx)(n.td,{children:"~140 MB"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\u30c7\u30d7\u30ed\u30a4\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",children:"\u30c7\u30d7\u30ed\u30a4\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8"}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u9069\u5207\u306a\u91cf\u5b50\u5316\u7cbe\u5ea6\u3092\u9078\u629e"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u30ad\u30e3\u30ea\u30d6\u30ec\u30fc\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf\u3092\u6e96\u5099\uff08INT8\uff09"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u30bf\u30fc\u30b2\u30c3\u30c8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u7cbe\u5ea6\u640d\u5931\u304c\u8a31\u5bb9\u7bc4\u56f2\u5185\u304b\u691c\u8a3c"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3067\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u30c6\u30b9\u30c8"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u6700\u9069\u5316"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\u81ea\u52d5\u5316\u3055\u308c\u305f\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u3092\u69cb\u7bc9"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\u95a2\u9023\u8a18\u4e8b",children:"\u95a2\u9023\u8a18\u4e8b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../gpu-optimization",children:"GPU\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u6700\u9069\u5316"})," \u2014 \u57fa\u672c\u7684\u306a\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../evaluation",children:"\u8a55\u4fa1\u3068\u30d9\u30f3\u30c1\u30de\u30fc\u30af"})," \u2014 \u30c7\u30d7\u30ed\u30a4\u5f8c\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u691c\u8a3c"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../../hands-on/integration",children:"\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3078\u306e\u7d71\u5408"})," \u2014 API\u7d71\u5408\u4f8b"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},30416(e,n,i){i.d(n,{R:()=>d,x:()=>l});var s=i(59471);const t={},r=s.createContext(t);function d(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);