---
import "tailwindcss/tailwind.css";
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
export const metadata = {
  title: "å°ç£å¥½æ£‹å¯¶å¯¶å”æœƒï½œåœæ£‹å”æœƒæ¨è–¦ï½œå…’ç«¥åœæ£‹èˆ‡è¦ªå­åœæ£‹çš„æ–‡åŒ–èˆ‡ç”Ÿæ´»ç¾å­¸",
  description: "å°ç£å¥½æ£‹å¯¶å¯¶å”æœƒï½œåœæ£‹å”æœƒæ¨è–¦ï½œå…’ç«¥åœæ£‹èˆ‡è¦ªå­åœæ£‹çš„æ–‡åŒ–èˆ‡ç”Ÿæ´»ç¾å­¸",
  keywords: "åœæ£‹",
  url: "https://www.weiqi.kids/",
  image: "favicon.png",
  datePublished: "2024-12-26",
};
---
<script type="text/javascript" src="wgo/wgo.min.js"></script>
<script type="text/javascript" src="wgo/wgo.player.min.js"></script>
<link type="text/css" href="wgo/wgo.player.css" rel="stylesheet" />
<Layout metadata={metadata}>
  <sl-breadcrumb>
    <sl-breadcrumb-item>
      <sl-icon slot="prefix" name="house"></sl-icon>
      <h1>å¥½æ£‹å¯¶å¯¶</h1>
    </sl-breadcrumb-item>
  </sl-breadcrumb>
  <div id="board" style="height: 90%;"/>
  <script type="text/javascript">
    /*
    var elem = document.getElementById("board");
    var player = new WGo.BasicPlayer(elem, {
      board: {
        size: 9,
        background: "wgo/wood_1024.jpg"
      },
      layout: {
        bottom: ['Control'],
      },
      sgf: "(;GM[1]SZ[9]KM[7]RU[Chinese]RE[W+R]PB[xris (1733)]PW[ZappanViikset (2112)];B[gd];W[ec];B[fe];W[de];B[cg];W[dg];B[cf];W[df];B[bd];W[cd];B[bc];W[gg];B[fc];W[ch];B[bh];W[dh];B[ce];W[ed];B[gf];W[hg];B[eb];W[db];B[fb];W[he];B[hf];W[if];B[hd];W[id];B[fg];W[fh];B[ic];W[ie];B[ig];W[ih];B[ge];W[ig];B[gh];W[eg];B[ef];W[hc];B[hb];W[ib];B[cc];W[dc];B[dd];W[ee];B[ff];W[gc];B[fd];W[gb])"
    });
    */
    const GAME_ID = "xzj9vnsf503n";  // æ£‹å±€ ID
    const USER_ID = "xris";          // ç©å®¶ ID
    let TOKEN = "";
    
    let socket = null;

    async function connectWebSocket() {
      // æ£‹å±€æ¸…å–®ï¼š5:::{"name":"c794948e","args":[{"gtype":"go9","page":"0"}]}
      
      // 1ï¸âƒ£ å–å¾— SESSION_ID
      let response = await fetch(`http://questgames.net:3002/socket.io/1/?t=${Date.now()}`);
      let text = await response.text();
      let SESSION_ID = text.split(":")[0];

      // 2ï¸âƒ£ å»ºç«‹ WebSocket é€£ç·š
      const socket = new WebSocket(`ws://questgames.net:3002/socket.io/1/websocket/${SESSION_ID}`);
      
      socket.onopen = function () {// console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
         // 3ï¸âƒ£ å•Ÿå‹• Ping-Pong å¿ƒè·³æ©Ÿåˆ¶
         setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            console.log("ğŸ”„ ç™¼é€ Ping (2::)");
            socket.send("2::"); // ç™¼é€ Ping
          }
        }, 25000); // Socket.IO 1.x é è¨­ 25 ç§’ Ping

        // 4ï¸âƒ£ æ­£å¼å®Œæˆé€£ç·šï¼Œå–å¾—ä¼ºæœå™¨è³‡è¨Š
        socket.send(`5:::{"name":"efa2bd1b","args":[{"env":"WEB","handicapV":"1","gtype":"go9"}]}`);
      };

      let lastServerStatus;
      let info;
      socket.onmessage = function (event) {
        let data = event.data;

        // 5ï¸âƒ£ ä¼ºæœå™¨ç™¼é€ Ping (2::)ï¼Œå›æ‡‰ Pong (3::)
        if (data === "2::") {
          console.log("ğŸ“¡ ä¼ºæœå™¨ Ping ä¾†äº†ï¼Œå›æ‡‰ Pong (3::)");
          socket.send("3::");
          return;
        }

        // 6ï¸âƒ£ è™•ç†æ£‹å±€å›æ‡‰
        if (data.startsWith('5:::')) {
          try {
            let jsonData = JSON.parse(data.slice(4)); // è·³é "5:::"
            if (jsonData.name === "ba276087") {
              console.log("ğŸ“© æ£‹å±€æ•¸æ“šæ¥æ”¶æˆåŠŸ", jsonData.args[0]);

              // è§£æ `moves` ä¸¦è½‰æ›ç‚º SGF æ ¼å¼
              let sgf = convertToSGF(jsonData.args[0]);
              console.log("ğŸ¯ è½‰æ›å¾Œçš„ SGF:", sgf);

              // é¡¯ç¤ºæ£‹ç›¤
              loadSGF(sgf);
            }
            else if (jsonData.name === "f19683a8") {// console.log("ğŸ“© ä¼ºæœå™¨è³‡è¨Šæ¥æ”¶æˆåŠŸ", jsonData.args[0]);
              if (!info) {
                socket.send(`5:::{"name":"d4b6e7ef","args":[{"id":"xris","gtype":"go9","token":"77n146dk"}]}`);
              }
              lastServerStatus = jsonData.args[0];
            }
            else if (jsonData.name === "d4b6e7ef") {// console.log("ğŸ“© å¸³è™Ÿæ¥æ”¶æˆåŠŸ", jsonData.args[0]);
              info = jsonData.args[0];
              TOKEN = info.token;
              // 7ï¸âƒ£ ç™¼é€è«‹æ±‚è¼‰å…¥æ­·å²æ£‹å±€
              socket.send(`5:::{"name":"c794948e","args":[{"gtype":"go9","page":"0"}]}`);
            }
            else if (jsonData.name === "c794948e") { console.log("ğŸ“© æ­£åœ¨é€²è¡Œçš„æ£‹å±€è³‡è¨Šæ¥æ”¶æˆåŠŸ"); console.table(jsonData.args[0].games);
              socket.send(`5:::{"name":"ba276087","args":[{"id":"xzj9vnsf503n","user_id":"xris","token":"77n146dk"}]}`);
            }
            else {
              console.log("ğŸ“© æœªçŸ¥çš„ä¼ºæœå™¨å›æ‡‰:", jsonData);
            }
          } catch (error) {
            console.error("âŒ è§£æ WebSocket è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
          }
        }
      };

      socket.addEventListener("error", (err) => {
        console.error("âŒ é€£ç·šéŒ¯èª¤", err);
      });

      socket.addEventListener("close", () => {
        console.log("ğŸ”´ WebSocket é€£ç·šé—œé–‰ï¼Œå˜—è©¦é‡æ–°é€£ç·š...");
      });
    }

    function convertToSGF(gameData) {
      let sgf = `(;SZ[${gameData.position.size}];PB[${gameData.players[0].name}]PW[${gameData.players[1].name}]`;
      gameData.position.moves.forEach(move => {
          sgf += `;${move.m}`;
      });
      sgf += ")";
      return sgf;
    }

    function loadSGF(sgf) {
      var elem = document.getElementById("board");
      new WGo.BasicPlayer(elem, {
        board: {
          size: 9,
          background: "https://wgo.waltheri.net/wgo/wood_1024.jpg"
        },
        layout: {
            bottom: ['Control'],
        },
        sgf: sgf
      });
    }
    connectWebSocket();
    </script>
</Layout>