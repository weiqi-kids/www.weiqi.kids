"use strict";(globalThis.webpackChunktemp_docusaurus=globalThis.webpackChunktemp_docusaurus||[]).push([[3306],{37599(n,e,s){s.r(e),s.d(e,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>l,toc:()=>o});const l=JSON.parse('{"id":"tech/deep-dive/source-code","title":"KataGo \u6e90\u4ee3\u7801\u5bfc\u8bfb","description":"KataGo \u4ee3\u7801\u7ed3\u6784\u3001\u6838\u5fc3\u6a21\u5757\u4e0e\u67b6\u6784\u8bbe\u8ba1","source":"@site/i18n/zh-cn/docusaurus-plugin-content-docs/current/tech/deep-dive/source-code.md","sourceDirName":"tech/deep-dive","slug":"/tech/deep-dive/source-code","permalink":"/zh-cn/docs/tech/deep-dive/source-code","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tech/deep-dive/source-code.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"KataGo \u6e90\u4ee3\u7801\u5bfc\u8bfb","description":"KataGo \u4ee3\u7801\u7ed3\u6784\u3001\u6838\u5fc3\u6a21\u5757\u4e0e\u67b6\u6784\u8bbe\u8ba1"},"sidebar":"tutorialSidebar","previous":{"title":"\u7ed9\u60f3\u6df1\u5165\u7814\u7a76\u7684\u4eba","permalink":"/zh-cn/docs/tech/deep-dive/"},"next":{"title":"KataGo \u8bad\u7ec3\u673a\u5236\u89e3\u6790","permalink":"/zh-cn/docs/tech/deep-dive/training"}}');var i=s(62615),r=s(30416);const c={sidebar_position:2,title:"KataGo \u6e90\u4ee3\u7801\u5bfc\u8bfb",description:"KataGo \u4ee3\u7801\u7ed3\u6784\u3001\u6838\u5fc3\u6a21\u5757\u4e0e\u67b6\u6784\u8bbe\u8ba1"},a="KataGo \u6e90\u4ee3\u7801\u5bfc\u8bfb",d={},o=[{value:"\u83b7\u53d6\u6e90\u4ee3\u7801",id:"\u83b7\u53d6\u6e90\u4ee3\u7801",level:2},{value:"\u76ee\u5f55\u7ed3\u6784",id:"\u76ee\u5f55\u7ed3\u6784",level:2},{value:"\u6838\u5fc3\u6a21\u5757\u89e3\u6790",id:"\u6838\u5fc3\u6a21\u5757\u89e3\u6790",level:2},{value:"1. game/ \u2014 \u56f4\u68cb\u89c4\u5219",id:"1-game--\u56f4\u68cb\u89c4\u5219",level:3},{value:"board.h / board.cpp",id:"boardh--boardcpp",level:4},{value:"rules.h / rules.cpp",id:"rulesh--rulescpp",level:4},{value:"2. search/ \u2014 MCTS \u641c\u7d22",id:"2-search--mcts-\u641c\u7d22",level:3},{value:"search.h / search.cpp",id:"searchh--searchcpp",level:4},{value:"searchparams.h",id:"searchparamsh",level:4},{value:"3. neuralnet/ \u2014 \u795e\u7ecf\u7f51\u7edc\u63a8\u7406",id:"3-neuralnet--\u795e\u7ecf\u7f51\u7edc\u63a8\u7406",level:3},{value:"nninputs.h / nninputs.cpp",id:"nninputsh--nninputscpp",level:4},{value:"nneval.h / nneval.cpp",id:"nnevalh--nnevalcpp",level:4},{value:"4. command/ \u2014 \u6307\u4ee4\u5904\u7406",id:"4-command--\u6307\u4ee4\u5904\u7406",level:3},{value:"gtp.cpp",id:"gtpcpp",level:4},{value:"analysis.cpp",id:"analysiscpp",level:4},{value:"Python \u8bad\u7ec3\u4ee3\u7801",id:"python-\u8bad\u7ec3\u4ee3\u7801",level:2},{value:"model.py \u2014 \u7f51\u7edc\u67b6\u6784",id:"modelpy--\u7f51\u7edc\u67b6\u6784",level:3},{value:"train.py \u2014 \u8bad\u7ec3\u5faa\u73af",id:"trainpy--\u8bad\u7ec3\u5faa\u73af",level:3},{value:"\u5173\u952e\u7b97\u6cd5\u5b9e\u73b0",id:"\u5173\u952e\u7b97\u6cd5\u5b9e\u73b0",level:2},{value:"PUCT \u9009\u62e9\u516c\u5f0f",id:"puct-\u9009\u62e9\u516c\u5f0f",level:3},{value:"\u865a\u62df\u635f\u5931",id:"\u865a\u62df\u635f\u5931",level:3},{value:"\u7f16\u8bd1\u4e0e\u8c03\u8bd5",id:"\u7f16\u8bd1\u4e0e\u8c03\u8bd5",level:2},{value:"\u7f16\u8bd1\uff08Debug \u6a21\u5f0f\uff09",id:"\u7f16\u8bd1debug-\u6a21\u5f0f",level:3},{value:"\u5355\u5143\u6d4b\u8bd5",id:"\u5355\u5143\u6d4b\u8bd5",level:3},{value:"\u8c03\u8bd5\u6280\u5de7",id:"\u8c03\u8bd5\u6280\u5de7",level:3},{value:"\u5ef6\u4f38\u9605\u8bfb",id:"\u5ef6\u4f38\u9605\u8bfb",level:2}];function t(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"katago-\u6e90\u4ee3\u7801\u5bfc\u8bfb",children:"KataGo \u6e90\u4ee3\u7801\u5bfc\u8bfb"})}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u6587\u5e26\u4f60\u4e86\u89e3 KataGo \u7684\u4ee3\u7801\u7ed3\u6784\uff0c\u9002\u5408\u60f3\u6df1\u5165\u7814\u7a76\u6216\u8d21\u732e\u4ee3\u7801\u7684\u5de5\u7a0b\u5e08\u3002"}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u83b7\u53d6\u6e90\u4ee3\u7801",children:"\u83b7\u53d6\u6e90\u4ee3\u7801"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"git clone https://github.com/lightvector/KataGo.git\ncd KataGo\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u76ee\u5f55\u7ed3\u6784",children:"\u76ee\u5f55\u7ed3\u6784"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"KataGo/\n\u251c\u2500\u2500 cpp/                    # C++ \u6838\u5fc3\u5f15\u64ce\n\u2502   \u251c\u2500\u2500 main.cpp            # \u4e3b\u7a0b\u5e8f\u5165\u53e3\n\u2502   \u251c\u2500\u2500 command/            # \u6307\u4ee4\u5904\u7406\n\u2502   \u251c\u2500\u2500 core/               # \u6838\u5fc3\u5de5\u5177\n\u2502   \u251c\u2500\u2500 game/               # \u56f4\u68cb\u89c4\u5219\n\u2502   \u251c\u2500\u2500 search/             # MCTS \u641c\u7d22\n\u2502   \u251c\u2500\u2500 neuralnet/          # \u795e\u7ecf\u7f51\u7edc\u63a8\u7406\n\u2502   \u251c\u2500\u2500 dataio/             # \u6570\u636e I/O\n\u2502   \u2514\u2500\u2500 tests/              # \u5355\u5143\u6d4b\u8bd5\n\u2502\n\u251c\u2500\u2500 python/                 # Python \u8bad\u7ec3\u4ee3\u7801\n\u2502   \u251c\u2500\u2500 train.py            # \u8bad\u7ec3\u4e3b\u7a0b\u5e8f\n\u2502   \u251c\u2500\u2500 model.py            # \u7f51\u7edc\u67b6\u6784\u5b9a\u4e49\n\u2502   \u251c\u2500\u2500 data/               # \u6570\u636e\u5904\u7406\n\u2502   \u2514\u2500\u2500 configs/            # \u8bad\u7ec3\u914d\u7f6e\n\u2502\n\u2514\u2500\u2500 docs/                   # \u6587\u6863\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u6838\u5fc3\u6a21\u5757\u89e3\u6790",children:"\u6838\u5fc3\u6a21\u5757\u89e3\u6790"}),"\n",(0,i.jsx)(e.h3,{id:"1-game--\u56f4\u68cb\u89c4\u5219",children:"1. game/ \u2014 \u56f4\u68cb\u89c4\u5219"}),"\n",(0,i.jsx)(e.p,{children:"\u56f4\u68cb\u89c4\u5219\u7684\u5b8c\u6574\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"boardh--boardcpp",children:"board.h / board.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u68cb\u76d8\u72b6\u6001\u8868\u793a\nclass Board {\npublic:\n    static constexpr int MAX_BOARD_SIZE = 19;\n\n    // \u68cb\u76d8\u72b6\u6001\n    Color colors[MAX_ARR_SIZE];  // \u6bcf\u4e2a\u4f4d\u7f6e\u7684\u989c\u8272\n    Chain chains[MAX_ARR_SIZE];  // \u68cb\u4e32\u4fe1\u606f\n\n    // \u6838\u5fc3\u64cd\u4f5c\n    bool playMove(Loc loc, Player pla);  // \u4e0b\u4e00\u6b65\u68cb\n    bool isLegal(Loc loc, Player pla);   // \u5224\u65ad\u5408\u6cd5\u6027\n    void calculateArea(Color* area);      // \u8ba1\u7b97\u9886\u5730\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"A2 \u6676\u683c\u6a21\u578b\uff1a\u68cb\u76d8\u7684\u6570\u636e\u7ed3\u6784"}),"\n",(0,i.jsx)(e.li,{children:"A6 \u8fde\u901a\u533a\u57df\uff1a\u68cb\u4e32\uff08Chain\uff09\u7684\u8868\u793a"}),"\n",(0,i.jsx)(e.li,{children:"A7 \u6c14\u7684\u8ba1\u7b97\uff1aliberty \u7684\u8ffd\u8e2a"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"rulesh--rulescpp",children:"rules.h / rules.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u591a\u89c4\u5219\u652f\u6301\nstruct Rules {\n    enum KoRule { SIMPLE_KO, POSITIONAL_KO, SITUATIONAL_KO };\n    enum ScoringRule { TERRITORY_SCORING, AREA_SCORING };\n    enum TaxRule { NO_TAX, TAX_SEKI, TAX_ALL };\n\n    KoRule koRule;\n    ScoringRule scoringRule;\n    TaxRule taxRule;\n    float komi;\n\n    // \u89c4\u5219\u540d\u79f0\u5bf9\u5e94\n    static Rules parseRules(const std::string& name);\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u652f\u6301\u7684\u89c4\u5219\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"chinese"}),"\uff1a\u4e2d\u56fd\u89c4\u5219\uff08\u6570\u5b50\uff09"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"japanese"}),"\uff1a\u65e5\u672c\u89c4\u5219\uff08\u6570\u76ee\uff09"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"korean"}),"\uff1a\u97e9\u56fd\u89c4\u5219"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"aga"}),"\uff1a\u7f8e\u56fd\u89c4\u5219"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"tromp-taylor"}),"\uff1aTromp-Taylor \u89c4\u5219"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"2-search--mcts-\u641c\u7d22",children:"2. search/ \u2014 MCTS \u641c\u7d22"}),"\n",(0,i.jsx)(e.p,{children:"\u8499\u7279\u5361\u6d1b\u6811\u641c\u7d22\u7684\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"searchh--searchcpp",children:"search.h / search.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"class Search {\npublic:\n    // \u6838\u5fc3\u641c\u7d22\n    void runWholeSearch(Player pla);\n\n    // MCTS \u6b65\u9aa4\n    void selectNode();           // \u9009\u62e9\u8282\u70b9\n    void expandNode();           // \u6269\u5c55\u8282\u70b9\n    void evaluateNode();         // \u795e\u7ecf\u7f51\u7edc\u8bc4\u4f30\n    void backpropValue();        // \u56de\u4f20\u66f4\u65b0\n\n    // \u7ed3\u679c\u83b7\u53d6\n    Loc getChosenMove();\n    std::vector<MoveInfo> getSortedMoveInfos();\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"C5 MCTS \u56db\u6b65\u9aa4\uff1a\u5bf9\u5e94 select \u2192 expand \u2192 evaluate \u2192 backprop"}),"\n",(0,i.jsxs)(e.li,{children:["E4 PUCT \u516c\u5f0f\uff1a\u5728 ",(0,i.jsx)(e.code,{children:"selectNode()"})," \u4e2d\u5b9e\u73b0"]}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"searchparamsh",children:"searchparams.h"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"struct SearchParams {\n    // \u641c\u7d22\u63a7\u5236\n    int64_t maxVisits;          // \u6700\u5927\u8bbf\u95ee\u6b21\u6570\n    double maxTime;             // \u6700\u5927\u65f6\u95f4\n\n    // PUCT \u53c2\u6570\n    double cpuctExploration;    // \u63a2\u7d22\u5e38\u6570\n    double cpuctBase;\n\n    // \u865a\u62df\u635f\u5931\n    int virtualLoss;\n\n    // \u6839\u8282\u70b9\u566a\u58f0\n    double rootNoiseEnabled;\n    double rootDirichletAlpha;\n};\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"3-neuralnet--\u795e\u7ecf\u7f51\u7edc\u63a8\u7406",children:"3. neuralnet/ \u2014 \u795e\u7ecf\u7f51\u7edc\u63a8\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u795e\u7ecf\u7f51\u7edc\u7684\u63a8\u7406\u5f15\u64ce\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"nninputsh--nninputscpp",children:"nninputs.h / nninputs.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u795e\u7ecf\u7f51\u7edc\u8f93\u5165\u7279\u5f81\nclass NNInputs {\npublic:\n    // \u7279\u5f81\u5e73\u9762\n    static constexpr int NUM_FEATURES = 22;\n\n    // \u586b\u5145\u7279\u5f81\n    static void fillFeatures(\n        const Board& board,\n        const BoardHistory& hist,\n        float* features\n    );\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u8f93\u5165\u7279\u5f81\u5305\u62ec\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u9ed1\u5b50\u4f4d\u7f6e\u3001\u767d\u5b50\u4f4d\u7f6e"}),"\n",(0,i.jsx)(e.li,{children:"\u6c14\u6570\uff081, 2, 3+\uff09"}),"\n",(0,i.jsx)(e.li,{children:"\u5386\u53f2\u68cb\u6b65"}),"\n",(0,i.jsx)(e.li,{children:"\u89c4\u5219\u7f16\u7801"}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"A10 \u5386\u53f2\u5806\u53e0\uff1a\u591a\u5e27\u8f93\u5165"}),"\n",(0,i.jsx)(e.li,{children:"A11 \u5408\u6cd5\u624b\u906e\u7f69\uff1a\u7981\u624b\u8fc7\u6ee4"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"nnevalh--nnevalcpp",children:"nneval.h / nneval.cpp"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u795e\u7ecf\u7f51\u7edc\u8bc4\u4f30\u7ed3\u679c\nstruct NNOutput {\n    // Policy \u8f93\u51fa\uff08362 \u4e2a\u4f4d\u7f6e\uff0c\u542b pass\uff09\n    float policyProbs[NNPos::MAX_NN_POLICY_SIZE];\n\n    // Value \u8f93\u51fa\n    float winProb;       // \u80dc\u7387\n    float lossProb;      // \u8d25\u7387\n    float noResultProb;  // \u548c\u68cb\u7387\n\n    // \u8f85\u52a9\u8f93\u51fa\n    float scoreMean;     // \u76ee\u6570\u9884\u6d4b\n    float scoreStdev;    // \u76ee\u6570\u6807\u51c6\u5dee\n    float lead;          // \u9886\u5148\u76ee\u6570\n\n    // \u9886\u5730\u9884\u6d4b\n    float ownership[NNPos::MAX_BOARD_AREA];\n};\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"E1 \u7b56\u7565\u7f51\u7edc\uff1apolicyProbs"}),"\n",(0,i.jsx)(e.li,{children:"E2 \u4ef7\u503c\u7f51\u7edc\uff1awinProb, scoreMean"}),"\n",(0,i.jsx)(e.li,{children:"E3 \u53cc\u5934\u7f51\u7edc\uff1a\u591a\u8f93\u51fa\u5934\u8bbe\u8ba1"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"4-command--\u6307\u4ee4\u5904\u7406",children:"4. command/ \u2014 \u6307\u4ee4\u5904\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0d\u540c\u8fd0\u884c\u6a21\u5f0f\u7684\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"gtpcpp",children:"gtp.cpp"}),"\n",(0,i.jsx)(e.p,{children:"GTP\uff08Go Text Protocol\uff09\u6a21\u5f0f\u7684\u5b9e\u73b0\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'void MainCmds::gtp(const std::vector<std::string>& args) {\n    // \u6307\u4ee4\u89e3\u6790\u4e0e\u6267\u884c\n    while(true) {\n        std::string line;\n        std::getline(std::cin, line);\n\n        if(line == "name") {\n            respond("KataGo");\n        }\n        else if(line.find("play") == 0) {\n            // \u5904\u7406\u4e0b\u68cb\u6307\u4ee4\n        }\n        else if(line.find("genmove") == 0) {\n            // \u6267\u884c\u641c\u7d22\u5e76\u8fd4\u56de\u6700\u4f73\u4e0b\u6cd5\n        }\n        // ... \u5176\u4ed6\u6307\u4ee4\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h4,{id:"analysiscpp",children:"analysis.cpp"}),"\n",(0,i.jsx)(e.p,{children:"Analysis Engine \u7684\u5b9e\u73b0\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"void MainCmds::analysis(const std::vector<std::string>& args) {\n    while(true) {\n        // \u8bfb\u53d6 JSON \u8bf7\u6c42\n        std::string line;\n        std::getline(std::cin, line);\n        json query = json::parse(line);\n\n        // \u5efa\u7acb\u68cb\u76d8\u72b6\u6001\n        Board board = setupBoard(query);\n\n        // \u6267\u884c\u5206\u6790\n        Search search(...);\n        search.runWholeSearch();\n\n        // \u8f93\u51fa JSON \u54cd\u5e94\n        json response = formatResponse(search);\n        std::cout << response.dump() << std::endl;\n    }\n}\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"python-\u8bad\u7ec3\u4ee3\u7801",children:"Python \u8bad\u7ec3\u4ee3\u7801"}),"\n",(0,i.jsx)(e.h3,{id:"modelpy--\u7f51\u7edc\u67b6\u6784",children:"model.py \u2014 \u7f51\u7edc\u67b6\u6784"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"class Model(nn.Module):\n    def __init__(self, config):\n        super().__init__()\n\n        # \u521d\u59cb\u5377\u79ef\n        self.initial_conv = nn.Conv2d(\n            in_channels=config.input_features,\n            out_channels=config.trunk_channels,\n            kernel_size=3, padding=1\n        )\n\n        # \u6b8b\u5dee\u5854\n        self.trunk = nn.ModuleList([\n            ResidualBlock(config.trunk_channels)\n            for _ in range(config.num_blocks)\n        ])\n\n        # \u8f93\u51fa\u5934\n        self.policy_head = PolicyHead(config)\n        self.value_head = ValueHead(config)\n        self.ownership_head = OwnershipHead(config)\n\n    def forward(self, x):\n        # \u521d\u59cb\u5377\u79ef\n        x = self.initial_conv(x)\n\n        # \u6b8b\u5dee\u5854\n        for block in self.trunk:\n            x = block(x)\n\n        # \u591a\u5934\u8f93\u51fa\n        policy = self.policy_head(x)\n        value = self.value_head(x)\n        ownership = self.ownership_head(x)\n\n        return policy, value, ownership\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"D9 \u5377\u79ef\u8fd0\u7b97\uff1aConv2d"}),"\n",(0,i.jsx)(e.li,{children:"D12 \u6b8b\u5dee\u8fde\u63a5\uff1aResidualBlock"}),"\n",(0,i.jsx)(e.li,{children:"E11 \u6b8b\u5dee\u5854\uff1atrunk \u7ed3\u6784"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"trainpy--\u8bad\u7ec3\u5faa\u73af",children:"train.py \u2014 \u8bad\u7ec3\u5faa\u73af"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"def train_step(model, optimizer, batch):\n    # \u524d\u5411\u4f20\u64ad\n    policy_pred, value_pred, ownership_pred = model(batch.inputs)\n\n    # \u8ba1\u7b97\u635f\u5931\n    policy_loss = cross_entropy(policy_pred, batch.policy_target)\n    value_loss = mse_loss(value_pred, batch.value_target)\n    ownership_loss = mse_loss(ownership_pred, batch.ownership_target)\n\n    total_loss = policy_loss + value_loss + ownership_loss\n\n    # \u53cd\u5411\u4f20\u64ad\n    optimizer.zero_grad()\n    total_loss.backward()\n    optimizer.step()\n\n    return total_loss.item()\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"D3 \u524d\u5411\u4f20\u64ad\uff1amodel(batch.inputs)"}),"\n",(0,i.jsx)(e.li,{children:"D13 \u53cd\u5411\u4f20\u64ad\uff1atotal_loss.backward()"}),"\n",(0,i.jsx)(e.li,{children:"K3 Adam\uff1aoptimizer.step()"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u5173\u952e\u7b97\u6cd5\u5b9e\u73b0",children:"\u5173\u952e\u7b97\u6cd5\u5b9e\u73b0"}),"\n",(0,i.jsx)(e.h3,{id:"puct-\u9009\u62e9\u516c\u5f0f",children:"PUCT \u9009\u62e9\u516c\u5f0f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// search.cpp\ndouble Search::getPUCTScore(const SearchNode* node, int moveIdx) {\n    double Q = node->getChildValue(moveIdx);\n    double P = node->getChildPolicy(moveIdx);\n    double N_parent = node->visits;\n    double N_child = node->getChildVisits(moveIdx);\n\n    double exploration = params.cpuctExploration;\n    double cpuct = exploration * sqrt(N_parent) / (1.0 + N_child);\n\n    return Q + cpuct * P;\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u865a\u62df\u635f\u5931",children:"\u865a\u62df\u635f\u5931"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u907f\u514d\u591a\u7ebf\u7a0b\u9009\u62e9\u76f8\u540c\u8282\u70b9\nvoid Search::applyVirtualLoss(SearchNode* node) {\n    node->virtualLoss += params.virtualLoss;\n}\n\nvoid Search::removeVirtualLoss(SearchNode* node) {\n    node->virtualLoss -= params.virtualLoss;\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u52a8\u753b\u5bf9\u5e94"}),"\uff1a"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"C9 \u865a\u62df\u635f\u5931\uff1a\u5e76\u884c\u641c\u7d22\u7684\u6280\u5de7"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u7f16\u8bd1\u4e0e\u8c03\u8bd5",children:"\u7f16\u8bd1\u4e0e\u8c03\u8bd5"}),"\n",(0,i.jsx)(e.h3,{id:"\u7f16\u8bd1debug-\u6a21\u5f0f",children:"\u7f16\u8bd1\uff08Debug \u6a21\u5f0f\uff09"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"cd cpp\nmkdir build && cd build\ncmake .. -DUSE_BACKEND=OPENCL -DCMAKE_BUILD_TYPE=Debug\nmake -j$(nproc)\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u5355\u5143\u6d4b\u8bd5",children:"\u5355\u5143\u6d4b\u8bd5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"./katago runtests\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u8c03\u8bd5\u6280\u5de7",children:"\u8c03\u8bd5\u6280\u5de7"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"// \u542f\u7528\u8be6\u7ec6\u65e5\u5fd7\n#define SEARCH_DEBUG 1\n\n// \u5728\u641c\u7d22\u4e2d\u52a0\u5165\u65ad\u70b9\nif(node->visits > 1000) {\n    // \u8bbe\u7f6e\u65ad\u70b9\u68c0\u67e5\u641c\u7d22\u72b6\u6001\n}\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u5ef6\u4f38\u9605\u8bfb",children:"\u5ef6\u4f38\u9605\u8bfb"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../training",children:"KataGo \u8bad\u7ec3\u673a\u5236\u89e3\u6790"})," \u2014 \u5b8c\u6574\u8bad\u7ec3\u6d41\u7a0b"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../contributing",children:"\u53c2\u4e0e\u5f00\u6e90\u793e\u533a"})," \u2014 \u8d21\u732e\u6307\u5357"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"../../how-it-works/concepts/",children:"\u6982\u5ff5\u901f\u67e5\u8868"})," \u2014 109 \u4e2a\u6982\u5ff5\u5bf9\u7167"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(t,{...n})}):t(n)}},30416(n,e,s){s.d(e,{R:()=>c,x:()=>a});var l=s(59471);const i={},r=l.createContext(i);function c(n){const e=l.useContext(r);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);